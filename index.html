<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcul Calorie - Tophe</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <style>
        /* Styles généraux (barres, etc.) */
        .nutrient-bar {
            height: 20px;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        .micronutrient-bar {
            height: 12px;
            border-radius: 6px;
            margin-bottom: 3px;
        }
        .protein { background-color: #4299e1; } /* Peut être remplacé par Tailwind: bg-blue-500 */
        .carbs { background-color: #48bb78; }  /* Peut être remplacé par Tailwind: bg-green-500 */
        .fat { background-color: #ed8936; }    /* Peut être remplacé par Tailwind: bg-orange-500 */

        .meal-tab.active {
            background-color: #4299e1; /* Ou bg-blue-600 */
            color: white;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* Ajusté pour moins d'espace en haut */
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%; /* Un peu plus large sur mobile */
            max-width: 500px;
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from {opacity: 0}
            to {opacity: 1}
        }

        @keyframes slideIn {
            from {transform: translateY(-30px); opacity: 0;} /* Moins de slide */
            to {transform: translateY(0); opacity: 1;}
        }

        /* Styles pour le générateur repliable */
        .generator-content {
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            max-height: 1000px; /* Hauteur max suffisante */
        }
        .generator-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-top: none;
            margin-top: 0; /* Ajusté */
            margin-bottom: 0; /* Ajusté */
        }

        /* Styles pour la section d'ajout d'aliment repliable */
        .add-food-content {
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            max-height: 1500px; /* Augmenté car plus de contenu */
        }
        .add-food-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-top: none;
            margin-top: 0;
            margin-bottom: 0;
        }
        /* Fin des styles pour l'ajout d'aliment repliable */

        /* Styles d'impression */
        @media print {
            body {
                width: 100%;
                margin: 0;
                padding: 0;
                font-size: 10pt; /* Taille plus adaptée à l'impression */
            }
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            .page-break { /* Utiliser dans le contenu généré pour PDF si nécessaire */
                page-break-after: always;
            }
            /* Cacher les éléments graphiques non essentiels */
             #macro-chart, #daily-macro-chart, #meals-chart {
                 display: none !important;
             }
             .modal, .modal-content {
                 display: none !important;
             }
             /* Simplifier certains styles pour l'impression */
            .shadow { box-shadow: none !important; }
            .rounded-lg { border-radius: 0 !important; }
            /* Masquer les boutons d'action dans la liste des repas imprimée */
            #meal-list .no-print {
                display: none !important;
            }
        }

        .print-only {
            display: none;
        }
    </style>
    <!-- <link rel="stylesheet" href="style.css"> --> <!-- Décommentez si vous externalisez le CSS -->
</head>
<body class="bg-gray-50 min-h-screen text-gray-800"> <!-- Ajout texte par défaut -->

    <!-- Top Navigation Bar -->
    <nav class="bg-blue-600 text-white shadow-md no-print">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold">Calculateur de Calories</h1>
                <div class="flex flex-wrap gap-2"> <!-- Utilisation de flex-wrap et gap -->
                    <button id="export-pdf-btn" class="px-3 py-1 bg-blue-500 hover:bg-blue-400 rounded-md text-sm font-medium transition-colors duration-200">
                        <i class="fas fa-file-pdf mr-1"></i> Exporter PDF
                    </button>
                    <button id="add-to-home-btn" class="px-3 py-1 bg-blue-500 hover:bg-blue-400 rounded-md text-sm font-medium transition-colors duration-200">
                        <i class="fas fa-mobile-alt mr-1"></i> Ajouter Accueil <!-- Icône changée -->
                    </button>
                    <button id="info-btn" class="px-3 py-1 bg-blue-500 hover:bg-blue-400 rounded-md text-sm font-medium transition-colors duration-200" aria-haspopup="dialog" aria-controls="info-modal"> <!-- Attributs ARIA -->
                        <i class="fas fa-info-circle mr-1"></i> Information
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenu Principal -->
    <main class="container mx-auto px-4 py-8" id="content-to-export">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Calculateur de Calories Journalier</h1>
            <p class="text-gray-600 mt-2">Composez et calculez vos repas pour toute la journée</p>
        </header>

        <!-- Section Génération Automatique (Repliable) -->
        <div class="bg-white rounded-lg shadow mb-8 no-print" id="generator-section">
            <!-- En-tête avec bouton Toggle -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 cursor-pointer" id="generator-header">
                <h2 class="text-xl font-semibold text-gray-800">Génération Automatique de Menu</h2>
                <button id="toggle-generator-btn" class="text-blue-500 hover:text-blue-700 text-xl" aria-controls="generator-content" aria-expanded="true">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>

            <!-- Contenu à masquer/afficher -->
            <div class="p-6 generator-content" id="generator-content" aria-hidden="false">
                <!-- Champ Calories -->
                <div class="mb-4">
                   <label for="target-calories" class="block text-gray-700 mb-1 text-sm font-medium">Calories journalières visées :</label>
                   <input type="number" id="target-calories" min="1000" value="2000" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- Choix de l'Objectif -->
                <div class="mb-6">
                   <label class="block text-gray-700 mb-2 text-sm font-medium">Quel est votre objectif ?</label>
                   <div class="flex flex-wrap gap-x-6 gap-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="obj-maintain" name="diet-objective" value="maintain" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                            <label for="obj-maintain" class="ml-2 block text-sm text-gray-900">Maintien du poids</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="obj-lose" name="diet-objective" value="loseWeight" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="obj-lose" class="ml-2 block text-sm text-gray-900">Perte de poids</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="obj-gain" name="diet-objective" value="gainMuscle" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <label for="obj-gain" class="ml-2 block text-sm text-gray-900">Prise de muscle</label>
                        </div>
                   </div>
                </div>
                <!-- Bouton Générer -->
                <div class="text-center">
                   <button id="generate-menu-btn" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-5 rounded-md transition duration-200">
                       <i class="fas fa-magic mr-2"></i>Générer le Menu
                   </button>
                </div>
                <!-- Zone de Feedback -->
                <div id="generation-feedback" class="mt-4 text-sm text-red-600"></div>
            </div>
             <!-- Fin Contenu Générateur -->
        </div>
        <!-- Fin Section Génération Automatique -->

        <!-- Onglets des repas -->
        <div class="flex flex-wrap mb-6 border-b border-gray-300 no-print" id="meal-tabs"> <!-- Style légèrement ajusté -->
            <button class="meal-tab active px-4 py-2 -mb-px mr-1 rounded-t-lg text-sm font-medium border-l border-t border-r border-gray-300 bg-white" data-meal="breakfast">
                <i class="fas fa-coffee mr-1"></i> Petit-déjeuner
            </button>
            <button class="meal-tab px-4 py-2 -mb-px mr-1 rounded-t-lg text-sm font-medium bg-gray-200 hover:bg-gray-300" data-meal="lunch">
                <i class="fas fa-utensils mr-1"></i> Déjeuner
            </button>
            <button class="meal-tab px-4 py-2 -mb-px mr-1 rounded-t-lg text-sm font-medium bg-gray-200 hover:bg-gray-300" data-meal="dinner">
                <i class="fas fa-utensils mr-1"></i> Dîner
            </button>
            <button class="meal-tab px-4 py-2 -mb-px mr-1 rounded-t-lg text-sm font-medium bg-gray-200 hover:bg-gray-300" data-meal="snack">
                <i class="fas fa-apple-alt mr-1"></i> Collation
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

            <!-- Section de sélection d'aliments (Maintenant Repliable) -->
            <div id="add-food-section" class="bg-white rounded-lg shadow no-print"> <!-- ID ajouté, p-6 supprimé -->

                <!-- En-tête avec bouton Toggle -->
                <div class="flex justify-between items-center p-4 border-b border-gray-200 cursor-pointer" id="add-food-header">
                    <h2 class="text-xl font-semibold text-gray-800">Ajouter un aliment manuellement</h2>
                    <button id="toggle-add-food-btn" class="text-blue-500 hover:text-blue-700 text-xl" aria-controls="add-food-content" aria-expanded="true">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>

                <!-- Contenu à masquer/afficher -->
                <div class="p-6 add-food-content" id="add-food-content" aria-hidden="false">
                    <!-- L'ancien H2 est déplacé ici et son ID reste pour la maj dynamique -->
                    <h2 class="text-lg font-medium mb-4 text-gray-700" id="current-meal-title">Ajouter un aliment au petit-déjeuner</h2>

                    <div class="mb-4">
                        <label for="food-category" class="block text-gray-700 mb-2 text-sm font-medium">Catégorie</label>
                        <select id="food-category" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Sélectionnez une catégorie</option>
                            <option value="legumes">Légumes</option>
                            <option value="fruits">Fruits</option>
                            <option value="feculents">Féculents</option>
                            <option value="viandes">Viandes</option>
                            <option value="poissons">Poissons</option>
                            <option value="produits_laitiers">Produits Laitiers</option>
                            <option value="cereales">Céréales et Pains</option>
                            <option value="petit_dejeuner">Autres (Petit Déjeuner)</option>
                            <option value="boissons">Boissons</option>
                            <option value="assaisonnement">Assaisonnements</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="food-item" class="block text-gray-700 mb-2 text-sm font-medium">Aliment</label>
                        <select id="food-item" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            <option value="">Sélectionnez d'abord une catégorie</option>
                        </select>
                    </div>

                    <div class="mb-6">
                        <label for="food-quantity" class="block text-gray-700 mb-2 text-sm font-medium">Quantité (g)</label>
                        <input type="number" id="food-quantity" min="1" value="100" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <button id="add-food-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Ajouter à mon repas
                    </button>

                    <div id="food-details" class="mt-6">
                        <h3 class="text-lg font-medium mb-3 text-gray-800">Détails nutritionnels (pour 100g)</h3>
                        <div id="food-details-content" class="text-gray-600">
                            Sélectionnez un aliment pour voir ses détails nutritionnels
                        </div>
                    </div>
                     <!-- Fin du contenu original -->
                </div>
                 <!-- Fin Contenu Ajout Manuel -->
            </div>
            <!-- Fin Section Sélection d'aliments -->

            <!-- Section du repas actuel -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800" id="current-meal-display">Mon petit-déjeuner</h2>
                <div id="meal-list" class="mb-6">
                    <p id="empty-meal-message" class="text-gray-500 italic">Aucun aliment ajouté à ce repas.</p>
                    <ul id="meal-items" class="divide-y divide-gray-200">
                        <!-- Les éléments du repas seront injectés ici par JS -->
                    </ul>
                </div>

                <div id="meal-summary" class="mt-6">
                    <h3 class="text-lg font-medium mb-3 text-gray-800">Résumé nutritionnel du repas</h3>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center"> <!-- Centré -->
                            <h4 class="text-sm font-medium text-gray-700 mb-1">Calories</h4>
                            <p id="total-calories" class="text-2xl font-bold text-gray-900">0 kcal</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center"> <!-- Centré -->
                            <h4 class="text-sm font-medium text-gray-700 mb-1">Poids</h4>
                            <p id="total-weight" class="text-2xl font-bold text-gray-900">0 g</p>
                        </div>
                    </div>

                    <h4 class="text-md font-medium mb-2 text-gray-800">Macronutriments (Répartition calorique)</h4>
                    <div id="macros-container" class="mb-6 space-y-2"> <!-- Ajout space-y -->
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-medium text-blue-700">Protéines</span>
                                <span id="total-protein" class="text-gray-600">0g (0%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="protein-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-medium text-green-700">Glucides</span>
                                <span id="total-carbs" class="text-gray-600">0g (0%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="carbs-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-medium text-orange-700">Lipides</span>
                                <span id="total-fat" class="text-gray-600">0g (0%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="fat-bar" class="bg-orange-500 h-2.5 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Graphique déplacé avant les micronutriments pour une meilleure disposition -->
                    <h4 class="text-md font-medium mb-2 text-gray-800">Graphique Répartition Calorique</h4>
                    <div class="w-full h-56 md:h-64 mb-6"> <!-- Hauteur ajustée -->
                        <canvas id="macro-chart"></canvas>
                    </div>

                    <h4 class="text-md font-medium mb-2 text-gray-800">Micronutriments (Estimés)</h4>
                    <div id="micronutrients-container" class="mb-4">
                        <p id="empty-micro-message" class="text-gray-500 italic">Ajoutez des aliments pour voir les micronutriments.</p>
                         <!-- Les micronutriments seront injectés ici par JS -->
                    </div>
                </div>
            </div>
            <!-- Fin Section Repas Actuel -->

        </div> <!-- Fin Grid -->

        <!-- Résumé quotidien -->
        <div class="mt-12 bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Résumé journalier</h2>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <h4 class="text-sm font-medium text-gray-700 mb-1">Calories Totales</h4>
                    <p id="daily-calories" class="text-2xl font-bold text-gray-900">0 kcal</p>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <h4 class="text-sm font-medium text-gray-700 mb-1">Protéines</h4>
                    <p id="daily-protein" class="text-xl font-bold text-gray-900">0 g</p> <!-- Taille réduite -->
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <h4 class="text-sm font-medium text-gray-700 mb-1">Glucides</h4>
                    <p id="daily-carbs" class="text-xl font-bold text-gray-900">0 g</p> <!-- Taille réduite -->
                </div>
                <div class="bg-orange-100 p-4 rounded-lg text-center">
                    <h4 class="text-sm font-medium text-gray-700 mb-1">Lipides</h4>
                    <p id="daily-fat" class="text-xl font-bold text-gray-900">0 g</p> <!-- Taille réduite -->
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                <div>
                    <h4 class="text-md font-medium mb-4 text-gray-800">Répartition Calorique par Repas</h4>
                    <div class="w-full h-64">
                        <canvas id="meals-chart"></canvas>
                    </div>
                </div>
                <div>
                    <h4 class="text-md font-medium mb-4 text-gray-800">Répartition Calorique des Macronutriments (Journée)</h4>
                    <div class="w-full h-64">
                        <canvas id="daily-macro-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <h4 class="text-md font-medium mb-2 text-gray-800">Détail par repas</h4>
                <div class="overflow-x-auto rounded-lg border border-gray-200"> <!-- Style du tableau amélioré -->
                    <table class="min-w-full bg-white text-sm"> <!-- Taille texte réduite -->
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="py-2 px-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Repas</th>
                                <th scope="col" class="py-2 px-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Calories</th>
                                <th scope="col" class="py-2 px-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Protéines</th>
                                <th scope="col" class="py-2 px-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Glucides</th>
                                <th scope="col" class="py-2 px-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Lipides</th>
                            </tr>
                        </thead>
                        <tbody id="meals-summary" class="divide-y divide-gray-200">
                            <!-- Lignes générées pour chaque repas -->
                             <tr>
                                <td class="py-2 px-3">Petit-déjeuner</td>
                                <td class="py-2 px-3" id="breakfast-calories">0 kcal</td>
                                <td class="py-2 px-3" id="breakfast-protein">0 g</td>
                                <td class="py-2 px-3" id="breakfast-carbs">0 g</td>
                                <td class="py-2 px-3" id="breakfast-fat">0 g</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-3">Déjeuner</td>
                                <td class="py-2 px-3" id="lunch-calories">0 kcal</td>
                                <td class="py-2 px-3" id="lunch-protein">0 g</td>
                                <td class="py-2 px-3" id="lunch-carbs">0 g</td>
                                <td class="py-2 px-3" id="lunch-fat">0 g</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-3">Dîner</td>
                                <td class="py-2 px-3" id="dinner-calories">0 kcal</td>
                                <td class="py-2 px-3" id="dinner-protein">0 g</td>
                                <td class="py-2 px-3" id="dinner-carbs">0 g</td>
                                <td class="py-2 px-3" id="dinner-fat">0 g</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-3">Collation</td>
                                <td class="py-2 px-3" id="snack-calories">0 kcal</td>
                                <td class="py-2 px-3" id="snack-protein">0 g</td>
                                <td class="py-2 px-3" id="snack-carbs">0 g</td>
                                <td class="py-2 px-3" id="snack-fat">0 g</td>
                            </tr>
                            <!-- Total Row -->
                            <tr class="bg-gray-100 font-semibold">
                                <td class="py-2 px-3">TOTAL</td>
                                <td class="py-2 px-3" id="total-daily-calories">0 kcal</td>
                                <td class="py-2 px-3" id="total-daily-protein">0 g</td>
                                <td class="py-2 px-3" id="total-daily-carbs">0 g</td>
                                <td class="py-2 px-3" id="total-daily-fat">0 g</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Bouton de réinitialisation -->
            <div class="mt-8 text-center no-print">
                <button id="reset-all-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-md transition duration-200">
                    <i class="fas fa-trash-alt mr-2"></i>Réinitialiser la journée
                </button>
            </div>
        </div>
        <!-- Fin Résumé Quotidien -->

    </main> <!-- Fin Contenu Principal -->

    <!-- Modales -->
    <!-- Modal d'information -->
    <div id="info-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="info-modal-title">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="info-modal-title" class="text-lg font-semibold">Information</h3>
                <button id="close-modal" class="text-gray-500 text-2xl hover:text-gray-800 leading-none" aria-label="Fermer">&times;</button> <!-- Bouton plus accessible -->
            </div>
            <div class="mb-4 text-sm space-y-3"> <!-- Taille texte réduite, espacement -->
                <p>Application développée par Tophe - Copyright 2024</p> <!-- Mise à jour date ? -->
                <p>Utilisez ce calculateur pour estimer rapidement les calories et macronutriments de vos repas.</p>
                <p class="font-semibold text-orange-700">Rappel important :</p>
                <p>Ces informations sont <strong>indicatives et basées sur des moyennes</strong>. Elles ne remplacent en aucun cas les conseils personnalisés d'un professionnel de la santé (diététicien(ne)-nutritionniste, médecin). Consultez un expert pour un plan alimentaire adapté à vos besoins spécifiques, votre état de santé et vos objectifs.</p>
                <p>La génération automatique de menu est un outil expérimental pour donner des idées, elle n'est pas garantie d'être parfaitement équilibrée ou variée.</p>
            </div>
            <div class="text-right mt-5">
                <button id="close-modal-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1.5 px-4 rounded-md transition duration-200 text-sm">
                    Compris
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de modification de quantité -->
    <div id="edit-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" id="edit-modal-title">Modifier la quantité</h3>
                <button id="close-edit-modal" class="text-gray-500 text-2xl hover:text-gray-800 leading-none" aria-label="Fermer">&times;</button>
            </div>
            <div class="mb-6">
                <label for="edit-quantity" class="block text-gray-700 mb-2 text-sm font-medium">Nouvelle quantité (g)</label>
                <input type="number" id="edit-quantity" min="1" value="100" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end space-x-3"> <!-- Espace augmenté -->
                <button id="cancel-edit-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-1.5 px-4 rounded-md transition duration-200 text-sm">
                    Annuler
                </button>
                <button id="confirm-edit-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-1.5 px-4 rounded-md transition duration-200 text-sm">
                    Confirmer
                </button>
            </div>
        </div>
    </div>

    <!-- Contenu spécifique pour PDF (caché par défaut) -->
    <div id="pdf-content" class="print-only">
        <h1 class="text-2xl font-bold mb-4">Mon plan alimentaire journalier</h1>
        <p class="mb-6">Date: <span id="pdf-date"></span></p>
        <div id="pdf-meals">
            <!-- Contenu généré dynamiquement pour le PDF -->
        </div>
        <footer class="mt-8 pt-4 border-t text-center text-xs text-gray-500">
            Généré par Calculateur Calories Tophe | Informations indicatives, consultez un professionnel.
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        // Attend que le DOM soit chargé
        document.addEventListener('DOMContentLoaded', () => {

            // Base de données des aliments (IMMENSE - Envisager de la mettre dans un fichier JSON séparé !)
            const foodDatabase = {
                 assaisonnement: { // NOUVELLE CATEGORIE - Trié alphabétiquement
                "Huile d'olive": {
                    calories: 884, protein: 0.0, carbs: 0.0, fat: 100.0,
                    micro: { "Vitamine E": { value: 14.4, unit: "mg" }, "Vitamine K": { value: 60.2, unit: "µg" }, "Gras Mono-insaturés": { value: 73, unit: "g" }, "Gras Saturés": { value: 14, unit: "g" }, "Gras Poly-insaturés": { value: 11, unit: "g" } }
                },
                "Huile de colza": {
                    calories: 884, protein: 0.0, carbs: 0.0, fat: 100.0,
                    micro: { "Vitamine E": { value: 17.5, unit: "mg" }, "Vitamine K": { value: 71.3, unit: "µg" }, "Oméga-3 (ALA)": { value: 9.1, unit: "g" }, "Gras Mono-insaturés": { value: 63, unit: "g" }, "Gras Poly-insaturés": { value: 28, unit: "g" } }
                },
                "Moutarde mi-forte": { // Type Dijon
                    calories: 143, protein: 7.9, carbs: 7.9, fat: 9.6,
                    micro: { "Sodium": { value: 2380, unit: "mg" }, "Sélénium": { value: 35.5, unit: "µg" }, "Magnésium": { value: 103, unit: "mg" }, "Calcium": { value: 162, unit: "mg" }, "Phosphore": { value: 284, unit: "mg" } }
                },
                "Sauce huitre": {
                    calories: 51, protein: 1.4, carbs: 11.5, fat: 0.2, // Varie beaucoup, souvent sucrée
                    micro: { "Sodium": { value: 2700, unit: "mg" }, "Sucre": { value: 8, unit: "g" }, "Calcium": { value: 23, unit: "mg" }, "Fer": { value: 0.5, unit: "mg" }, "Potassium": { value: 40, unit: "mg" } }
                },
                "Sauce soja salée": {
                    calories: 53, protein: 8.0, carbs: 5.6, fat: 0.1,
                    micro: { "Sodium": { value: 5493, unit: "mg" }, "Manganèse": { value: 0.5, unit: "mg" }, "Magnésium": { value: 41, unit: "mg" }, "Phosphore": { value: 116, unit: "mg" }, "Fer": { value: 1.6, unit: "mg" } }
                },
                "Vinaigre balsamique": {
                    calories: 88, protein: 0.5, carbs: 17.0, fat: 0.0, // Contient des sucres du raisin
                    micro: { "Potassium": { value: 112, unit: "mg" }, "Calcium": { value: 27, unit: "mg" }, "Manganèse": { value: 0.1, unit: "mg" }, "Fer": { value: 0.7, unit: "mg" }, "Sucre": { value: 15, unit: "g" } }
                },
                "Vinaigre de cidre": {
                    calories: 21, protein: 0.0, carbs: 0.9, fat: 0.0,
                    micro: { "Potassium": { value: 73, unit: "mg" }, "Sodium": { value: 5, unit: "mg" }, "Calcium": { value: 7, unit: "mg" }, "Magnésium": { value: 5, unit: "mg" }, "Phosphore": { value: 8, unit: "mg" } }
                },
                "Vinaigre de vin (rouge)": {
                    calories: 19, protein: 0.04, carbs: 0.3, fat: 0.0,
                    micro: { "Potassium": { value: 39, unit: "mg" }, "Sodium": { value: 4, unit: "mg" }, "Calcium": { value: 6, unit: "mg" }, "Magnésium": { value: 4, unit: "mg" }, "Fer": { value: 0.4, unit: "mg" } }
                }
            },
			legumes: { // Trié alphabétiquement
                "Ail": {
                    calories: 149, protein: 6.4, carbs: 33.1, fat: 0.5,
                    micro: { "Vitamine C": { value: 31.2, unit: "mg" }, "Vitamine B6": { value: 1.2, unit: "mg" }, "Manganèse": { value: 1.7, unit: "mg" }, "Sélénium": { value: 14.2, unit: "µg" }, "Calcium": { value: 181, unit: "mg" } }
                },
                "Aubergine": {
                    calories: 25, protein: 1.0, carbs: 6.0, fat: 0.2,
                    micro: { "Potassium": { value: 229, unit: "mg" }, "Folate": { value: 22, unit: "µg" }, "Vitamine K": { value: 3.5, unit: "µg" }, "Magnésium": { value: 14, unit: "mg" }, "Manganèse": { value: 0.3, unit: "mg" } }
                },
                "Betterave": {
                    calories: 43, protein: 1.6, carbs: 9.6, fat: 0.2,
                    micro: { "Folate": { value: 109, unit: "µg" }, "Manganèse": { value: 0.3, unit: "mg" }, "Potassium": { value: 325, unit: "mg" }, "Vitamine C": { value: 4.9, unit: "mg" }, "Magnésium": { value: 23, unit: "mg" } }
                },
                "Brocoli": {
                    calories: 34, protein: 2.8, carbs: 6.6, fat: 0.4,
                    micro: { "Vitamine C": { value: 89.2, unit: "mg" }, "Vitamine K": { value: 101.6, unit: "µg" }, "Folate": { value: 63, unit: "µg" }, "Potassium": { value: 316, unit: "mg" }, "Magnésium": { value: 21, unit: "mg" } }
                },
                "Carotte": {
                    calories: 41, protein: 0.9, carbs: 9.6, fat: 0.2,
                    micro: { "Vitamine A": { value: 835, unit: "µg" }, "Vitamine C": { value: 5.9, unit: "mg" }, "Potassium": { value: 320, unit: "mg" }, "Calcium": { value: 33, unit: "mg" }, "Fer": { value: 0.3, unit: "mg" } }
                },
                "Céleri (branche)": {
                    calories: 16, protein: 0.7, carbs: 3.0, fat: 0.2,
                    micro: { "Vitamine K": { value: 29.3, unit: "µg" }, "Potassium": { value: 260, unit: "mg" }, "Vitamine A": { value: 22, unit: "µg" }, "Folate": { value: 36, unit: "µg" }, "Vitamine C": { value: 3.1, unit: "mg" } }
                },
                "Champignons": {
                    calories: 22, protein: 3.1, carbs: 3.3, fat: 0.3,
                    micro: { "Niacine": { value: 3.6, unit: "mg" }, "Riboflavine": { value: 0.4, unit: "mg" }, "Cuivre": { value: 0.3, unit: "mg" }, "Sélénium": { value: 9.3, unit: "µg" }, "Potassium": { value: 318, unit: "mg" } }
                },
                "Chicorée / Endive": {
                    calories: 17, protein: 1.3, carbs: 3.4, fat: 0.2, // Données pour Endive
                    micro: { "Folate": { value: 142, unit: "µg" }, "Vitamine K": { value: 231, unit: "µg" }, "Vitamine A": { value: 108, unit: "µg" }, "Manganèse": { value: 0.4, unit: "mg" }, "Potassium": { value: 314, unit: "mg" } }
                },
                "Chou Cabus (Vert)": {
                    calories: 25, protein: 1.3, carbs: 5.8, fat: 0.1,
                    micro: { "Vitamine K": { value: 76, unit: "µg" }, "Vitamine C": { value: 36.6, unit: "mg" }, "Folate": { value: 43, unit: "µg" }, "Manganèse": { value: 0.2, unit: "mg" }, "Calcium": { value: 40, unit: "mg" } }
                },
                "Chou de Bruxelles": {
                    calories: 43, protein: 3.4, carbs: 8.9, fat: 0.3,
                    micro: { "Vitamine K": { value: 177, unit: "µg" }, "Vitamine C": { value: 85, unit: "mg" }, "Folate": { value: 61, unit: "µg" }, "Vitamine A": { value: 38, unit: "µg" }, "Manganèse": { value: 0.3, unit: "mg" } }
                },
                "Chou Kale (Frisé)": {
                    calories: 49, protein: 4.3, carbs: 8.8, fat: 0.9,
                    micro: { "Vitamine K": { value: 390, unit: "µg" }, "Vitamine A": { value: 241, unit: "µg" }, "Vitamine C": { value: 120, unit: "mg" }, "Manganèse": { value: 0.7, unit: "mg" }, "Calcium": { value: 150, unit: "mg" } }
                },
                "Chou-fleur": {
                    calories: 25, protein: 1.9, carbs: 5.0, fat: 0.3,
                    micro: { "Vitamine C": { value: 48.2, unit: "mg" }, "Vitamine K": { value: 15.5, unit: "µg" }, "Folate": { value: 57, unit: "µg" }, "Vitamine B6": { value: 0.2, unit: "mg" }, "Potassium": { value: 299, unit: "mg" } }
                },
                "Chou-rave": {
                    calories: 27, protein: 1.7, carbs: 6.2, fat: 0.1,
                    micro: { "Vitamine C": { value: 62, unit: "mg" }, "Potassium": { value: 350, unit: "mg" }, "Vitamine B6": { value: 0.15, unit: "mg" }, "Cuivre": { value: 0.1, unit: "mg" }, "Manganèse": { value: 0.1, unit: "mg" } }
                },
                "Concombre": {
                    calories: 15, protein: 0.7, carbs: 3.6, fat: 0.1,
                    micro: { "Vitamine K": { value: 16.4, unit: "µg" }, "Potassium": { value: 147, unit: "mg" }, "Vitamine C": { value: 2.8, unit: "mg" }, "Magnésium": { value: 13, unit: "mg" }, "Manganèse": { value: 0.1, unit: "mg" } }
                },
                "Courgette": {
                    calories: 17, protein: 1.2, carbs: 3.1, fat: 0.3,
                    micro: { "Vitamine C": { value: 17.9, unit: "mg" }, "Potassium": { value: 261, unit: "mg" }, "Folate": { value: 24, unit: "µg" }, "Magnésium": { value: 18, unit: "mg" }, "Vitamine B6": { value: 0.2, unit: "mg" } }
                },
                "Épinard": {
                    calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4,
                    micro: { "Vitamine A": { value: 469, unit: "µg" }, "Vitamine C": { value: 28, unit: "mg" }, "Vitamine K": { value: 483, unit: "µg" }, "Calcium": { value: 99, unit: "mg" }, "Fer": { value: 2.7, unit: "mg" } }
                },
                "Fenouil (Bulbe)": {
                    calories: 31, protein: 1.2, carbs: 7.3, fat: 0.2,
                    micro: { "Vitamine C": { value: 12, unit: "mg" }, "Potassium": { value: 414, unit: "mg" }, "Manganèse": { value: 0.2, unit: "mg" }, "Folate": { value: 27, unit: "µg" }, "Calcium": { value: 49, unit: "mg" } }
                },
                "Haricots verts": {
                    calories: 31, protein: 1.8, carbs: 7.0, fat: 0.1,
                    micro: { "Vitamine C": { value: 12.2, unit: "mg" }, "Vitamine K": { value: 48, unit: "µg" }, "Folate": { value: 33, unit: "µg" }, "Potassium": { value: 209, unit: "mg" }, "Calcium": { value: 37, unit: "mg" } }
                },
                "Laitue (Romaine)": {
                    calories: 17, protein: 1.2, carbs: 3.3, fat: 0.3,
                    micro: { "Vitamine K": { value: 102.5, unit: "µg" }, "Vitamine A": { value: 436, unit: "µg" }, "Folate": { value: 136, unit: "µg" }, "Vitamine C": { value: 4, unit: "mg" }, "Potassium": { value: 247, unit: "mg" } }
                },
                "Mâche": {
                    calories: 21, protein: 2.0, carbs: 3.6, fat: 0.4,
                    micro: { "Vitamine C": { value: 38.2, unit: "mg" }, "Vitamine A": { value: 355, unit: "µg" }, "Fer": { value: 2.2, unit: "mg" }, "Potassium": { value: 459, unit: "mg" }, "Vitamine B6": { value: 0.3, unit: "mg" } }
                },
                "Navet": {
                    calories: 28, protein: 0.9, carbs: 6.4, fat: 0.1,
                    micro: { "Vitamine C": { value: 21, unit: "mg" }, "Potassium": { value: 191, unit: "mg" }, "Calcium": { value: 30, unit: "mg" }, "Folate": { value: 15, unit: "µg" }, "Manganèse": { value: 0.1, unit: "mg" } }
                },
                "Oignon": {
                    calories: 40, protein: 1.1, carbs: 9.3, fat: 0.1,
                    micro: { "Vitamine C": { value: 7.4, unit: "mg" }, "Vitamine B6": { value: 0.1, unit: "mg" }, "Folate": { value: 19, unit: "µg" }, "Potassium": { value: 146, unit: "mg" }, "Manganèse": { value: 0.1, unit: "mg" } }
                },
                "Panais": {
                    calories: 75, protein: 1.2, carbs: 18.0, fat: 0.3,
                    micro: { "Vitamine C": { value: 17, unit: "mg" }, "Folate": { value: 67, unit: "µg" }, "Manganèse": { value: 0.6, unit: "mg" }, "Potassium": { value: 375, unit: "mg" }, "Vitamine K": { value: 22.5, unit: "µg" } }
                },
                 "Poireau": {
                    calories: 61, protein: 1.5, carbs: 14.2, fat: 0.3,
                    micro: { "Vitamine K": { value: 47, unit: "µg" }, "Manganèse": { value: 0.5, unit: "mg" }, "Vitamine A": { value: 83, unit: "µg" }, "Vitamine C": { value: 12, unit: "mg" }, "Folate": { value: 64, unit: "µg" } }
                 },
                 "Poirée / Bette": {
                    calories: 19, protein: 1.8, carbs: 3.7, fat: 0.2,
                    micro: { "Vitamine K": { value: 830, unit: "µg" }, "Vitamine A": { value: 306, unit: "µg" }, "Magnésium": { value: 81, unit: "mg" }, "Vitamine C": { value: 30, unit: "mg" }, "Potassium": { value: 379, unit: "mg" } }
                },
                "Poivron rouge": {
                    calories: 31, protein: 1.0, carbs: 6.0, fat: 0.3,
                    micro: { "Vitamine C": { value: 128, unit: "mg" }, "Vitamine A": { value: 157, unit: "µg" }, "Vitamine B6": { value: 0.3, unit: "mg" }, "Folate": { value: 21, unit: "µg" }, "Potassium": { value: 211, unit: "mg" } }
                },
                "Pomme de terre": {
                    calories: 77, protein: 2.0, carbs: 17.5, fat: 0.1,
                    micro: { "Vitamine C": { value: 19.7, unit: "mg" }, "Potassium": { value: 421, unit: "mg" }, "Vitamine B6": { value: 0.3, unit: "mg" }, "Magnésium": { value: 23, unit: "mg" }, "Niacine": { value: 1.1, unit: "mg" } }
                },
                "Radis": {
                    calories: 16, protein: 0.7, carbs: 3.4, fat: 0.1,
                    micro: { "Vitamine C": { value: 14.8, unit: "mg" }, "Folate": { value: 25, unit: "µg" }, "Potassium": { value: 233, unit: "mg" }, "Calcium": { value: 25, unit: "mg" }, "Magnésium": { value: 10, unit: "mg" } }
                },
                "Roquette": {
                    calories: 25, protein: 2.6, carbs: 3.7, fat: 0.7,
                    micro: { "Vitamine K": { value: 109, unit: "µg" }, "Vitamine A": { value: 119, unit: "µg" }, "Calcium": { value: 160, unit: "mg" }, "Folate": { value: 97, unit: "µg" }, "Vitamine C": { value: 15, unit: "mg" } }
                },
                "Tomate": {
                    calories: 18, protein: 0.9, carbs: 3.9, fat: 0.2,
                    micro: { "Vitamine C": { value: 13.7, unit: "mg" }, "Potassium": { value: 237, unit: "mg" }, "Vitamine A": { value: 42, unit: "µg" }, "Vitamine K": { value: 7.9, unit: "µg" }, "Lycopène": { value: 2573, unit: "µg" } }
                }
            },
            fruits: { // Trié alphabétiquement (avec ajouts)
                "Amandes": { // NOUVEAU
                    calories: 579, protein: 21.2, carbs: 21.6, fat: 49.9, // Valeurs pour 100g crues
                    micro: { "Vitamine E": { value: 25.6, unit: "mg" }, "Magnésium": { value: 270, unit: "mg" }, "Calcium": { value: 269, unit: "mg" }, "Fer": { value: 3.7, unit: "mg" }, "Fibres": { value: 12.5, unit: "g" } }
                },
                "Banane": {
                    calories: 89, protein: 1.1, carbs: 22.8, fat: 0.3,
                    micro: { "Vitamine C": { value: 8.7, unit: "mg" }, "Potassium": { value: 358, unit: "mg" }, "Vitamine B6": { value: 0.4, unit: "mg" }, "Magnésium": { value: 27, unit: "mg" }, "Folate": { value: 20, unit: "µg" } }
                },
                "Fraise": {
                    calories: 32, protein: 0.7, carbs: 7.7, fat: 0.3,
                    micro: { "Vitamine C": { value: 58.8, unit: "mg" }, "Manganèse": { value: 0.6, unit: "mg" }, "Folate": { value: 24, unit: "µg" }, "Potassium": { value: 153, unit: "mg" }, "Magnésium": { value: 13, unit: "mg" } }
                },
                "Kiwi": {
                    calories: 61, protein: 1.1, carbs: 14.7, fat: 0.5,
                    micro: { "Vitamine C": { value: 92.7, unit: "mg" }, "Vitamine K": { value: 40.3, unit: "µg" }, "Potassium": { value: 312, unit: "mg" }, "Vitamine E": { value: 1.5, unit: "mg" }, "Folate": { value: 25, unit: "µg" } }
                },
                "Myrtille": {
                    calories: 57, protein: 0.7, carbs: 14.5, fat: 0.3,
                    micro: { "Vitamine C": { value: 9.7, unit: "mg" }, "Vitamine K": { value: 19.3, unit: "µg" }, "Manganèse": { value: 0.3, unit: "mg" }, "Potassium": { value: 77, unit: "mg" }, "Antioxydants": { value: 9621, unit: "ORAC" } }
                },
                "Noisettes": { // NOUVEAU
                    calories: 628, protein: 15.0, carbs: 16.7, fat: 60.8, // Valeurs pour 100g crues
                    micro: { "Vitamine E": { value: 15.0, unit: "mg" }, "Manganèse": { value: 6.2, unit: "mg" }, "Cuivre": { value: 1.7, unit: "mg" }, "Magnésium": { value: 163, unit: "mg" }, "Fibres": { value: 9.7, unit: "g" } }
                },
                "Noix": { // NOUVEAU (Noix de Grenoble)
                    calories: 654, protein: 15.2, carbs: 13.7, fat: 65.2, // Valeurs pour 100g crues
                    micro: { "Oméga-3 (ALA)": { value: 9.1, unit: "g" }, "Manganèse": { value: 3.4, unit: "mg" }, "Cuivre": { value: 1.6, unit: "mg" }, "Magnésium": { value: 158, unit: "mg" }, "Fibres": { value: 6.7, unit: "g" } }
                },
                "Orange": {
                    calories: 47, protein: 0.9, carbs: 11.8, fat: 0.1,
                    micro: { "Vitamine C": { value: 53.2, unit: "mg" }, "Folate": { value: 30, unit: "µg" }, "Potassium": { value: 181, unit: "mg" }, "Thiamine": { value: 0.1, unit: "mg" }, "Calcium": { value: 40, unit: "mg" } }
                },
                "Pêche": {
                    calories: 39, protein: 0.9, carbs: 9.5, fat: 0.3,
                    micro: { "Vitamine C": { value: 6.6, unit: "mg" }, "Vitamine A": { value: 16, unit: "µg" }, "Potassium": { value: 190, unit: "mg" }, "Niacine": { value: 0.8, unit: "mg" }, "Fibres": { value: 1.5, unit: "g" } }
                },
                "Poire": {
                    calories: 57, protein: 0.4, carbs: 15.2, fat: 0.1,
                    micro: { "Vitamine C": { value: 4.3, unit: "mg" }, "Vitamine K": { value: 4.4, unit: "µg" }, "Potassium": { value: 116, unit: "mg" }, "Cuivre": { value: 0.1, unit: "mg" }, "Fibres": { value: 3.1, unit: "g" } }
                },
                "Pomme": {
                    calories: 52, protein: 0.3, carbs: 13.8, fat: 0.2,
                    micro: { "Vitamine C": { value: 4.6, unit: "mg" }, "Potassium": { value: 107, unit: "mg" }, "Fibres": { value: 2.4, unit: "g" }, "Vitamine K": { value: 2.2, unit: "µg" }, "Manganèse": { value: 0.04, unit: "mg" } }
                }
            },
            viandes: { // Trié alphabétiquement (avec ajouts)
                "Agneau (côtelette)": {
                    calories: 294, protein: 24.9, carbs: 0.0, fat: 21.0,
                    micro: { "Vitamine B12": { value: 2.3, unit: "µg" }, "Niacine": { value: 7.9, unit: "mg" }, "Zinc": { value: 4.2, unit: "mg" }, "Fer": { value: 1.9, unit: "mg" }, "Sélénium": { value: 24.5, unit: "µg" } }
                },
                "Bœuf (steak)": {
                    calories: 271, protein: 26.0, carbs: 0.0, fat: 18.0,
                    micro: { "Fer": { value: 2.6, unit: "mg" }, "Zinc": { value: 5.4, unit: "mg" }, "Vitamine B12": { value: 2.6, unit: "µg" }, "Niacine": { value: 6.2, unit: "mg" }, "Sélénium": { value: 33.1, unit: "µg" } }
                },
                "Bœuf haché (15% MG)": {
                    calories: 250, protein: 26.1, carbs: 0.0, fat: 15.0,
                    micro: { "Fer": { value: 2.7, unit: "mg" }, "Zinc": { value: 6.0, unit: "mg" }, "Vitamine B12": { value: 2.3, unit: "µg" }, "Niacine": { value: 5.4, unit: "mg" }, "Vitamine B6": { value: 0.4, unit: "mg" } }
                },
                "Dinde (blanc)": { // Blanc de dinde nature, pas le jambon de dinde transformé
                    calories: 135, protein: 29.9, carbs: 0.0, fat: 1.0,
                    micro: { "Niacine": { value: 7.1, unit: "mg" }, "Vitamine B6": { value: 0.6, unit: "mg" }, "Phosphore": { value: 229, unit: "mg" }, "Sélénium": { value: 30.7, unit: "µg" }, "Zinc": { value: 1.3, unit: "mg" } }
                },
                "Jambon blanc (cuit, découenné, dégraissé)": { // NOUVEAU
                    calories: 120, protein: 21.0, carbs: 0.5, fat: 4.0,
                    micro: { "Sodium": { value: 1100, unit: "mg" }, "Phosphore": { value: 220, unit: "mg" }, "Sélénium": { value: 35, unit: "µg" }, "Zinc": { value: 2.0, unit: "mg" }, "Niacine": { value: 6.0, unit: "mg" } }
                },
                 "Jambon cru (type Serrano/Parme)": { // NOUVEAU
                    calories: 250, protein: 26.0, carbs: 0.5, fat: 16.0,
                    micro: { "Sodium": { value: 2000, unit: "mg" }, "Phosphore": { value: 200, unit: "mg" }, "Zinc": { value: 2.5, unit: "mg" }, "Niacine": { value: 7.0, unit: "mg" }, "Sélénium": { value: 40, unit: "µg" } }
                },
                "Jambon de dinde": { // NOUVEAU (Produit transformé)
                    calories: 115, protein: 19.0, carbs: 1.5, fat: 3.5,
                    micro: { "Sodium": { value: 1050, unit: "mg" }, "Phosphore": { value: 200, unit: "mg" }, "Sélénium": { value: 30, unit: "µg" }, "Niacine": { value: 8.0, unit: "mg" }, "Zinc": { value: 1.0, unit: "mg" } }
                },
                "Jambon de poulet": { // NOUVEAU (Produit transformé)
                    calories: 110, protein: 22.0, carbs: 0.5, fat: 2.0,
                    micro: { "Sodium": { value: 1000, unit: "mg" }, "Phosphore": { value: 250, unit: "mg" }, "Sélénium": { value: 25, unit: "µg" }, "Niacine": { value: 10.0, unit: "mg" }, "Vitamine B6": { value: 0.5, unit: "mg" } }
                },
                "Lapin": {
                    calories: 173, protein: 33.0, carbs: 0.0, fat: 3.5,
                    micro: { "Vitamine B12": { value: 6.8, unit: "µg" }, "Niacine": { value: 12.8, unit: "mg" }, "Potassium": { value: 380, unit: "mg" }, "Phosphore": { value: 240, unit: "mg" }, "Sélénium": { value: 23.7, unit: "µg" } }
                },
                "Porc (côtelette)": {
                    calories: 231, protein: 25.0, carbs: 0.0, fat: 14.0,
                    micro: { "Thiamine": { value: 0.9, unit: "mg" }, "Niacine": { value: 6.3, unit: "mg" }, "Vitamine B6": { value: 0.4, unit: "mg" }, "Phosphore": { value: 213, unit: "mg" }, "Zinc": { value: 2.4, unit: "mg" } }
                },
                "Poulet (blanc)": {
                    calories: 165, protein: 31.0, carbs: 0.0, fat: 3.6,
                    micro: { "Niacine": { value: 13.7, unit: "mg" }, "Vitamine B6": { value: 0.6, unit: "mg" }, "Phosphore": { value: 228, unit: "mg" }, "Sélénium": { value: 27.6, unit: "µg" }, "Zinc": { value: 1.0, unit: "mg" } }
                },
                 "Rôti de porc (longe, cuit)": { // NOUVEAU
                    calories: 200, protein: 30.0, carbs: 0.0, fat: 8.0,
                    micro: { "Thiamine": { value: 0.9, unit: "mg" }, "Sélénium": { value: 45, unit: "µg" }, "Phosphore": { value: 280, unit: "mg" }, "Niacine": { value: 9.0, unit: "mg" }, "Zinc": { value: 2.5, unit: "mg" } }
                },
                "Veau (escalope)": {
                    calories: 172, protein: 30.9, carbs: 0.0, fat: 5.1,
                    micro: { "Vitamine B12": { value: 1.3, unit: "µg" }, "Zinc": { value: 3.1, unit: "mg" }, "Fer": { value: 1.1, unit: "mg" }, "Phosphore": { value: 253, unit: "mg" }, "Sélénium": { value: 9.8, unit: "µg" } }
                }
            },
            poissons: { // Trié alphabétiquement
                "Bar (loup de mer)": {
                    calories: 124, protein: 24.0, carbs: 0.0, fat: 2.5,
                    micro: { "Vitamine B12": { value: 3.6, unit: "µg" }, "Potassium": { value: 256, unit: "mg" }, "Phosphore": { value: 201, unit: "mg" }, "Sélénium": { value: 36.5, unit: "µg" }, "Magnésium": { value: 31, unit: "mg" } }
                },
                "Cabillaud": {
                    calories: 82, protein: 18.0, carbs: 0.0, fat: 0.7,
                    micro: { "Vitamine B12": { value: 1.0, unit: "µg" }, "Vitamine B6": { value: 0.3, unit: "mg" }, "Phosphore": { value: 203, unit: "mg" }, "Sélénium": { value: 33.1, unit: "µg" }, "Potassium": { value: 321, unit: "mg" } }
                },
                "Crevettes": {
                    calories: 99, protein: 24.0, carbs: 0.0, fat: 0.3,
                    micro: { "Sélénium": { value: 38.0, unit: "µg" }, "Vitamine B12": { value: 1.7, unit: "µg" }, "Fer": { value: 2.6, unit: "mg" }, "Zinc": { value: 1.5, unit: "mg" }, "Cuivre": { value: 0.2, unit: "mg" } }
                },
                "Dorade": {
                    calories: 128, protein: 21.6, carbs: 0.0, fat: 4.0,
                    micro: { "Vitamine B12": { value: 1.9, unit: "µg" }, "Phosphore": { value: 254, unit: "mg" }, "Sélénium": { value: 32.7, unit: "µg" }, "Potassium": { value: 328, unit: "mg" }, "Vitamine D": { value: 1.7, unit: "µg" } }
                },
                "Maquereau": {
                    calories: 205, protein: 19.0, carbs: 0.0, fat: 14.0,
                    micro: { "Vitamine D": { value: 16.1, unit: "µg" }, "Vitamine B12": { value: 7.8, unit: "µg" }, "Oméga-3": { value: 2.6, unit: "g" }, "Magnésium": { value: 97, unit: "mg" }, "Potassium": { value: 314, unit: "mg" } }
                },
                "Sardine": {
                    calories: 208, protein: 24.6, carbs: 0.0, fat: 11.5,
                    micro: { "Vitamine D": { value: 4.8, unit: "µg" }, "Calcium": { value: 382, unit: "mg" }, "Vitamine B12": { value: 8.9, unit: "µg" }, "Fer": { value: 2.9, unit: "mg" }, "Oméga-3": { value: 1.4, unit: "g" } }
                },
                "Saumon": {
                    calories: 208, protein: 20.0, carbs: 0.0, fat: 13.0,
                    micro: { "Vitamine D": { value: 11.0, unit: "µg" }, "Vitamine B12": { value: 2.6, unit: "µg" }, "Oméga-3": { value: 2.3, unit: "g" }, "Sélénium": { value: 36.5, unit: "µg" }, "Potassium": { value: 363, unit: "mg" } }
                },
                "Thon": {
                    calories: 144, protein: 30.0, carbs: 0.0, fat: 1.0,
                    micro: { "Vitamine B12": { value: 2.5, unit: "µg" }, "Niacine": { value: 11.3, unit: "mg" }, "Sélénium": { value: 65.7, unit: "µg" }, "Potassium": { value: 441, unit: "mg" }, "Phosphore": { value: 267, unit: "mg" } }
                },
                "Truite": {
                    calories: 141, protein: 19.9, carbs: 0.0, fat: 6.2,
                    micro: { "Vitamine B12": { value: 3.5, unit: "µg" }, "Niacine": { value: 5.4, unit: "mg" }, "Potassium": { value: 375, unit: "mg" }, "Phosphore": { value: 226, unit: "mg" }, "Vitamine D": { value: 7.5, unit: "µg" } }
                }
            },
            produits_laitiers: { // Trié alphabétiquement
                "Cottage cheese": {
                    calories: 98, protein: 11.0, carbs: 3.1, fat: 4.3,
                    micro: { "Calcium": { value: 83, unit: "mg" }, "Phosphore": { value: 151, unit: "mg" }, "Sélénium": { value: 6.8, unit: "µg" }, "Vitamine B12": { value: 0.5, unit: "µg" }, "Zinc": { value: 0.4, unit: "mg" } }
                },
                "Fromage blanc 0%": {
                    calories: 56, protein: 10.0, carbs: 3.0, fat: 0.0,
                    micro: { "Calcium": { value: 120, unit: "mg" }, "Phosphore": { value: 153, unit: "mg" }, "Vitamine B12": { value: 0.3, unit: "µg" }, "Potassium": { value: 133, unit: "mg" }, "Zinc": { value: 0.5, unit: "mg" } }
                },
                "Fromage de chèvre": {
                    calories: 364, protein: 21.6, carbs: 2.5, fat: 29.8,
                    micro: { "Calcium": { value: 298, unit: "mg" }, "Phosphore": { value: 236, unit: "mg" }, "Vitamine A": { value: 378, unit: "µg" }, "Vitamine K": { value: 3.1, unit: "µg" }, "Riboflavine": { value: 0.5, unit: "mg" } }
                },
                "Lait demi-écrémé": {
                    calories: 47, protein: 3.3, carbs: 4.8, fat: 1.6,
                    micro: { "Calcium": { value: 120, unit: "mg" }, "Phosphore": { value: 95, unit: "mg" }, "Vitamine B12": { value: 0.4, unit: "µg" }, "Riboflavine": { value: 0.2, unit: "mg" }, "Vitamine D": { value: 0.1, unit: "µg" } }
                },
                 "Skyr": {
                    calories: 63, protein: 11.0, carbs: 4.0, fat: 0.2,
                    micro: { "Calcium": { value: 120, unit: "mg" }, "Phosphore": { value: 110, unit: "mg" }, "Vitamine B12": { value: 0.9, unit: "µg" }, "Riboflavine": { value: 0.3, unit: "mg" }, "Potassium": { value: 140, unit: "mg" } }
                },
                "Yaourt grec": {
                    calories: 97, protein: 9.0, carbs: 3.6, fat: 5.0,
                    micro: { "Calcium": { value: 115, unit: "mg" }, "Phosphore": { value: 135, unit: "mg" }, "Vitamine B12": { value: 0.5, unit: "µg" }, "Sélénium": { value: 9.7, unit: "µg" }, "Zinc": { value: 0.7, unit: "mg" } }
                },
                "Yaourt nature": {
                    calories: 59, protein: 3.6, carbs: 4.7, fat: 3.2,
                    micro: { "Calcium": { value: 121, unit: "mg" }, "Phosphore": { value: 95, unit: "mg" }, "Vitamine B12": { value: 0.4, unit: "µg" }, "Riboflavine": { value: 0.2, unit: "mg" }, "Probiotiques": { value: 10000000, unit: "UFC" } }
                }
            },
            feculents: { // CATEGORIE FECULENTS - Trié alphabétiquement (avec ajout)
                 "Haricot Rouge (cuit)": { // NOUVEAU
                    calories: 127, protein: 8.7, carbs: 22.8, fat: 0.5,
                    micro: { "Fibres": { value: 6.4, unit: "g" }, "Fer": { value: 2.9, unit: "mg" }, "Folate": { value: 130, unit: "µg" }, "Potassium": { value: 405, unit: "mg" }, "Manganèse": { value: 0.4, unit: "mg" } }
                },
                 "Lentilles (cuites)": {
                    calories: 116, protein: 9.0, carbs: 20.1, fat: 0.4,
                    micro: { "Folate": { value: 181, unit: "µg" }, "Fer": { value: 3.3, unit: "mg" }, "Manganèse": { value: 0.5, unit: "mg" }, "Fibres": { value: 7.9, unit: "g" }, "Thiamine": { value: 0.2, unit: "mg" } }
                },
                "Pain blanc": {
                    calories: 265, protein: 9.0, carbs: 49.0, fat: 3.2, // Varie beaucoup selon le pain
                    micro: { "Sélénium": { value: 19.0, unit: "µg" }, "Thiamine": { value: 0.1, unit: "mg" }, "Folate": { value: 25, unit: "µg" }, "Fer": { value: 1.0, unit: "mg" }, "Calcium": { value: 14, unit: "mg" } }
                },
                "Patate Douce (cuite)": {
                    calories: 86, protein: 1.6, carbs: 20.1, fat: 0.1,
                    micro: { "Vitamine A": { value: 709, unit: "µg" }, "Vitamine C": { value: 2.4, unit: "mg" }, "Manganèse": { value: 0.3, unit: "mg" }, "Vitamine B6": { value: 0.2, unit: "mg" }, "Potassium": { value: 337, unit: "mg" } }
                },
                "Pâtes (blanches, cuites)": {
                    calories: 131, protein: 5.2, carbs: 25.2, fat: 1.1, // Standard, sans sauce
                    micro: { "Sélénium": { value: 27.6, unit: "µg" }, "Manganèse": { value: 0.3, unit: "mg" }, "Folate": { value: 6, unit: "µg" }, "Thiamine": { value: 0.02, unit: "mg" }, "Fibres": { value: 1.8, unit: "g" } }
                },
                "Pois Chiche (cuits)": {
                    calories: 164, protein: 8.9, carbs: 27.4, fat: 2.6,
                    micro: { "Manganèse": { value: 1.0, unit: "mg" }, "Folate": { value: 172, unit: "µg" }, "Cuivre": { value: 0.4, unit: "mg" }, "Fer": { value: 2.9, unit: "mg" }, "Fibres": { value: 7.6, unit: "g" } }
                },
                "Quinoa (cuit)": {
                    calories: 120, protein: 4.4, carbs: 21.3, fat: 1.9,
                    micro: { "Manganèse": { value: 0.6, unit: "mg" }, "Magnésium": { value: 64, unit: "mg" }, "Phosphore": { value: 152, unit: "mg" }, "Folate": { value: 42, unit: "µg" }, "Fibres": { value: 2.8, unit: "g" } }
                },
                "Riz Blanc (cuit)": {
                    calories: 130, protein: 2.7, carbs: 28.2, fat: 0.3,
                    micro: { "Manganèse": { value: 0.4, unit: "mg" }, "Sélénium": { value: 9.8, unit: "µg" }, "Thiamine": { value: 0.02, unit: "mg" }, "Niacine": { value: 0.4, unit: "mg" }, "Fer": { value: 0.2, unit: "mg" } }
                }
            },
			cereales: { // Trié alphabétiquement
                "Flocons d'avoine": {
                    calories: 375, protein: 13.0, carbs: 67.5, fat: 7.0,
                    micro: { "Fibres": { value: 10.0, unit: "g" }, "Manganèse": { value: 4.9, unit: "mg" }, "Phosphore": { value: 523, unit: "mg" }, "Magnésium": { value: 177, unit: "mg" }, "Zinc": { value: 4.0, unit: "mg" } }
                },
                "Granola": {
                    calories: 471, protein: 10.0, carbs: 64.0, fat: 20.0,
                    micro: { "Fibres": { value: 7.0, unit: "g" }, "Fer": { value: 4.0, unit: "mg" }, "Magnésium": { value: 120, unit: "mg" }, "Zinc": { value: 3.7, unit: "mg" }, "Manganèse": { value: 3.0, unit: "mg" } }
                },
                "Muesli": {
                    calories: 378, protein: 9.0, carbs: 68.0, fat: 8.0,
                    micro: { "Fibres": { value: 8.5, unit: "g" }, "Fer": { value: 3.0, unit: "mg" }, "Magnésium": { value: 110, unit: "mg" }, "Phosphore": { value: 306, unit: "mg" }, "Zinc": { value: 2.1, unit: "mg" } }
                },
                "Pain aux céréales": {
                    calories: 265, protein: 11.0, carbs: 43.0, fat: 5.0,
                    micro: { "Fibres": { value: 8.0, unit: "g" }, "Magnésium": { value: 68, unit: "mg" }, "Fer": { value: 2.8, unit: "mg" }, "Zinc": { value: 2.0, unit: "mg" }, "Vitamine E": { value: 1.0, unit: "mg" } }
                },
                "Pain complet": {
                    calories: 247, protein: 10.0, carbs: 41.0, fat: 3.3,
                    micro: { "Fibres": { value: 7.0, unit: "g" }, "Magnésium": { value: 90, unit: "mg" }, "Sélénium": { value: 35.0, unit: "µg" }, "Niacine": { value: 5.0, unit: "mg" }, "Fer": { value: 2.5, unit: "mg" } }
                },
                "Pain de seigle": {
                    calories: 259, protein: 8.5, carbs: 48.0, fat: 3.0,
                    micro: { "Fibres": { value: 8.0, unit: "g" }, "Manganèse": { value: 1.9, unit: "mg" }, "Phosphore": { value: 208, unit: "mg" }, "Magnésium": { value: 40, unit: "mg" }, "Zinc": { value: 1.8, unit: "mg" } }
                },
                "Riz brun": { // Assumons cuit pour ces valeurs typiques
                    calories: 111, protein: 2.6, carbs: 23.0, fat: 0.9,
                    micro: { "Magnésium": { value: 43, unit: "mg" }, "Phosphore": { value: 83, unit: "mg" }, "Manganèse": { value: 1.1, unit: "mg" }, "Sélénium": { value: 19.1, unit: "µg" }, "Fibres": { value: 1.8, unit: "g" } }
                }
            },
            petit_dejeuner: { // Trié alphabétiquement
                "Avocat": {
                    calories: 160, protein: 2.0, carbs: 8.5, fat: 14.7,
                    micro: { "Vitamine K": { value: 21.0, unit: "µg" }, "Folate": { value: 81, unit: "µg" }, "Vitamine C": { value: 10, unit: "mg" }, "Potassium": { value: 485, unit: "mg" }, "Vitamine B5": { value: 1.4, unit: "mg" } }
                },
                "Bacon": {
                    calories: 417, protein: 37.0, carbs: 1.4, fat: 33.0, // Typiquement cuit
                    micro: { "Niacine": { value: 12.0, unit: "mg" }, "Vitamine B12": { value: 0.7, unit: "µg" }, "Fer": { value: 0.9, unit: "mg" }, "Zinc": { value: 2.5, unit: "mg" }, "Phosphore": { value: 198, unit: "mg" } }
                },
                "Beurre d'amande": {
                    calories: 614, protein: 21.0, carbs: 19.0, fat: 55.0,
                    micro: { "Vitamine E": { value: 24.0, unit: "mg" }, "Magnésium": { value: 270, unit: "mg" }, "Calcium": { value: 347, unit: "mg" }, "Fer": { value: 3.7, unit: "mg" }, "Zinc": { value: 3.3, unit: "mg" } }
                },
                "Beurre de cacahuète": {
                    calories: 588, protein: 25.0, carbs: 20.0, fat: 50.0,
                    micro: { "Niacine": { value: 13.0, unit: "mg" }, "Magnésium": { value: 170, unit: "mg" }, "Phosphore": { value: 335, unit: "mg" }, "Zinc": { value: 2.8, unit: "mg" }, "Vitamine E": { value: 8.3, unit: "mg" } }
                },
                "Confiture de fraises": {
                    calories: 250, protein: 0.4, carbs: 65.0, fat: 0.0,
                    micro: { "Vitamine C": { value: 4.0, unit: "mg" }, "Calcium": { value: 8.0, unit: "mg" }, "Potassium": { value: 37, unit: "mg" }, "Magnésium": { value: 3.0, unit: "mg" }, "Fer": { value: 0.2, unit: "mg" } }
                },
                "Miel": {
                    calories: 304, protein: 0.3, carbs: 82.4, fat: 0.0,
                    micro: { "Niacine": { value: 0.1, unit: "mg" }, "Riboflavine": { value: 0.04, unit: "mg" }, "Potassium": { value: 52, unit: "mg" }, "Zinc": { value: 0.2, unit: "mg" }, "Fer": { value: 0.4, unit: "mg" } }
                },
                "Œuf (entier)": { // Moyenne pour 100g (environ 2 gros oeufs)
                    calories: 143, protein: 12.6, carbs: 0.7, fat: 9.5,
                    micro: { "Vitamine B12": { value: 0.9, unit: "µg" }, "Vitamine A": { value: 149, unit: "µg" }, "Sélénium": { value: 31.7, unit: "µg" }, "Lutéine": { value: 292, unit: "µg" }, "Choline": { value: 294, unit: "mg" } }
                }
            },
            boissons: { // Trié alphabétiquement
                 "Café": { // Noir, sans sucre/lait
                    calories: 2, protein: 0.1, carbs: 0.0, fat: 0.0,
                    micro: { "Niacine": { value: 0.5, unit: "mg" }, "Magnésium": { value: 7.1, unit: "mg" }, "Potassium": { value: 116, unit: "mg" }, "Manganèse": { value: 0.05, unit: "mg" }, "Antioxydants": { value: 1000, unit: "ORAC" } } // ORAC est indicatif
                },
                "Jus d'ananas": { // 100% pur jus
                    calories: 50, protein: 0.5, carbs: 12.0, fat: 0.1,
                    micro: { "Vitamine C": { value: 25.8, unit: "mg" }, "Vitamine B6": { value: 0.1, unit: "mg" }, "Magnésium": { value: 15, unit: "mg" }, "Potassium": { value: 180, unit: "mg" }, "Manganèse": { value: 1.0, unit: "mg" } }
                },
                "Jus de carotte": { // 100% pur jus
                    calories: 39, protein: 0.9, carbs: 9.3, fat: 0.2,
                    micro: { "Vitamine A": { value: 900, unit: "µg" }, "Vitamine K": { value: 20.2, unit: "µg" }, "Potassium": { value: 292, unit: "mg" }, "Vitamine C": { value: 9.1, unit: "mg" }, "Calcium": { value: 30, unit: "mg" } }
                },
                 "Jus d'orange": { // 100% pur jus
                    calories: 45, protein: 0.7, carbs: 10.4, fat: 0.2,
                    micro: { "Vitamine C": { value: 36.4, unit: "mg" }, "Folate": { value: 27.3, unit: "µg" }, "Potassium": { value: 200, unit: "mg" }, "Thiamine": { value: 0.1, unit: "mg" }, "Vitamine A": { value: 25, unit: "µg" } }
                },
                "Jus de pomme": { // 100% pur jus
                    calories: 47, protein: 0.1, carbs: 11.3, fat: 0.1,
                    micro: { "Vitamine C": { value: 2.2, unit: "mg" }, "Potassium": { value: 120, unit: "mg" }, "Magnésium": { value: 7, unit: "mg" }, "Calcium": { value: 8, unit: "mg" }, "Antioxydants": { value: 800, unit: "ORAC" } } // ORAC est indicatif
                },
                "Jus de raisin": { // 100% pur jus
                    calories: 60, protein: 0.5, carbs: 15.0, fat: 0.0,
                    micro: { "Vitamine C": { value: 1.0, unit: "mg" }, "Potassium": { value: 144, unit: "mg" }, "Manganèse": { value: 0.12, unit: "mg" }, "Antioxydants": { value: 1600, unit: "ORAC" }, "Calcium": { value: 15, unit: "mg" } } // ORAC est indicatif
                },
                "Jus de tomate": { // 100% pur jus
                    calories: 17, protein: 0.8, carbs: 4.0, fat: 0.1,
                    micro: { "Vitamine C": { value: 18.3, unit: "mg" }, "Vitamine A": { value: 56, unit: "µg" }, "Potassium": { value: 217, unit: "mg" }, "Lycopène": { value: 3100, unit: "µg" }, "Folate": { value: 9, unit: "µg" } }
                },
                "Thé": { // Infusé, sans sucre/lait
                    calories: 1, protein: 0.0, carbs: 0.2, fat: 0.0,
                    micro: { "Manganèse": { value: 0.5, unit: "mg" }, "Fluorure": { value: 0.3, unit: "mg" }, "Potassium": { value: 88, unit: "mg" }, "Antioxydants": { value: 1200, unit: "ORAC" }, "Théine": { value: 25, unit: "mg" } } // ORAC/Théine indicatifs
                }
            }
        };

            // Structure des repas
            const meals = {
                breakfast: { name: "Petit-déjeuner", items: [], icon: "coffee" },
                lunch: { name: "Déjeuner", items: [], icon: "utensils" },
                dinner: { name: "Dîner", items: [], icon: "utensils" },
                snack: { name: "Collation", items: [], icon: "apple-alt" }
            };

            // État de l'application
            let activeMeal = "breakfast";
            let currentEditId = null;
            let currentEditMeal = null;
            let macroChart = null;
            let dailyMacroChart = null;
            let mealsChart = null;

            // Récupération des éléments DOM (utilisez const par défaut)
            const mealTabsContainer = document.getElementById('meal-tabs');
            const mealTabs = mealTabsContainer ? mealTabsContainer.querySelectorAll('.meal-tab') : [];
            const currentMealTitle = document.getElementById('current-meal-title');
            const currentMealDisplay = document.getElementById('current-meal-display');
            const categorySelect = document.getElementById('food-category');
            const foodSelect = document.getElementById('food-item');
            const quantityInput = document.getElementById('food-quantity');
            const addFoodBtn = document.getElementById('add-food-btn');
            const foodDetailsContent = document.getElementById('food-details-content');
            const mealList = document.getElementById('meal-items');
            const emptyMealMessage = document.getElementById('empty-meal-message');
            const totalCalories = document.getElementById('total-calories');
            const totalWeight = document.getElementById('total-weight');
            const totalProtein = document.getElementById('total-protein');
            const totalCarbs = document.getElementById('total-carbs');
            const totalFat = document.getElementById('total-fat');
            const proteinBar = document.getElementById('protein-bar');
            const carbsBar = document.getElementById('carbs-bar');
            const fatBar = document.getElementById('fat-bar');
            const micronutrientsContainer = document.getElementById('micronutrients-container');
            const emptyMicroMessage = document.getElementById('empty-micro-message');
            const resetAllBtn = document.getElementById('reset-all-btn');
            const infoBtn = document.getElementById('info-btn');
            const infoModal = document.getElementById('info-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const closeModalX = document.getElementById('close-modal');
            const addToHomeBtn = document.getElementById('add-to-home-btn');
            const editModal = document.getElementById('edit-modal');
            const editModalTitle = document.getElementById('edit-modal-title');
            const editQuantity = document.getElementById('edit-quantity');
            const confirmEditBtn = document.getElementById('confirm-edit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const closeEditModalX = document.getElementById('close-edit-modal');
            const exportPdfBtn = document.getElementById('export-pdf-btn');

            // --- Éléments pour sections repliables ---
            // Générateur
            const generatorHeader = document.getElementById('generator-header');
            const generatorContent = document.getElementById('generator-content');
            const toggleGeneratorBtn = document.getElementById('toggle-generator-btn');
            const generatorToggleIcon = toggleGeneratorBtn ? toggleGeneratorBtn.querySelector('i') : null;
            const targetCaloriesInput = document.getElementById('target-calories');
            const generateMenuBtn = document.getElementById('generate-menu-btn');
            const generationFeedback = document.getElementById('generation-feedback');

            // Ajout Manuel
            const addFoodHeader = document.getElementById('add-food-header');
            const addFoodContent = document.getElementById('add-food-content');
            const toggleAddFoodBtn = document.getElementById('toggle-add-food-btn');
            const addFoodToggleIcon = toggleAddFoodBtn ? toggleAddFoodBtn.querySelector('i') : null;

             // --- FONCTIONS UTILITAIRES ---

            // Calcule les nutriments pour une quantité donnée
            function calculateNutrients(foodData, quantity) {
                if (!foodData || quantity <= 0) {
                    return { calories: 0, protein: 0, carbs: 0, fat: 0, micro: {} };
                }
                const factor = quantity / 100;
                const calculated = {
                    calories: (foodData.calories || 0) * factor,
                    protein: (foodData.protein || 0) * factor,
                    carbs: (foodData.carbs || 0) * factor,
                    fat: (foodData.fat || 0) * factor,
                    micro: {}
                };
                if (foodData.micro) {
                    for (const [key, microData] of Object.entries(foodData.micro)) {
                        if (microData && typeof microData.value === 'number' && microData.unit) {
                            calculated.micro[key] = {
                                value: (microData.value || 0) * factor,
                                unit: microData.unit
                            };
                         } else {
                             console.warn(`Donnée micro invalide pour ${key} dans ${foodData.name || 'aliment inconnu'}:`, microData);
                         }
                    }
                }
                return calculated;
            }

            // Met à jour l'affichage d'un titre de repas
            function updateMealTitles() {
                 const mealName = meals[activeMeal]?.name || 'Repas';
                 const mealNameLower = mealName.toLowerCase();
                 const preposition = mealNameLower === 'collation' ? 'à la' : 'au';

                 if(currentMealTitle) currentMealTitle.textContent = `Ajouter un aliment ${preposition} ${mealNameLower}`;
                 if(currentMealDisplay) {
                     if (activeMeal === 'snack') {
                         currentMealDisplay.textContent = mealName; // Juste "Collation"
                     } else {
                         currentMealDisplay.textContent = `Mon ${mealNameLower}`;
                     }
                 }
            }

            // Ouvre une modale
            function openModal(modalElement) {
                if (!modalElement) return;
                modalElement.style.display = 'block';
                // Ajouter la gestion du focus trap ici si implémenté
                // Exemple: modalElement.querySelector('input, button').focus();
            }

            // Ferme une modale
            function closeModal(modalElement) {
                if (!modalElement) return;
                modalElement.style.display = 'none';
                // Ajouter la restauration du focus ici si implémenté
            }

            // --- FONCTIONS PRINCIPALES ---

            function updateFoodItems() {
                const category = categorySelect.value;
                foodSelect.innerHTML = ''; // Vider les options précédentes
                foodSelect.disabled = true; // Désactiver par défaut

                const defaultOption = document.createElement('option');
                defaultOption.value = '';

                if (category && foodDatabase[category]) {
                    foodSelect.disabled = false;
                    defaultOption.textContent = 'Sélectionnez un aliment';
                    foodSelect.appendChild(defaultOption);

                    // Trier les aliments alphabétiquement
                    const foodNames = Object.keys(foodDatabase[category]).sort();

                    foodNames.forEach(foodName => {
                        const option = document.createElement('option');
                        option.value = foodName;
                        option.textContent = foodName;
                        foodSelect.appendChild(option);
                    });
                } else {
                    defaultOption.textContent = category ? "Aucun aliment dans cette catégorie" : "Sélectionnez d'abord une catégorie";
                    foodSelect.appendChild(defaultOption);
                }

                updateFoodDetails(); // Mettre à jour les détails même si la catégorie est vide
            }

            function updateFoodDetails() {
                const category = categorySelect.value;
                const foodName = foodSelect.value;
                const quantity = parseInt(quantityInput.value) || 100; // Utiliser 100 par défaut si invalide

                 // Afficher les détails pour 100g, peu importe la quantité entrée
                const displayQuantity = 100;

                if (category && foodName && foodDatabase[category] && foodDatabase[category][foodName]) {
                    const food = foodDatabase[category][foodName];
                    // Calculer pour 100g pour l'affichage des détails
                    const nutrientsFor100g = calculateNutrients(food, displayQuantity);

                    let detailsHTML = `
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="bg-gray-100 p-2 rounded">
                                <p class="text-gray-600">Calories</p>
                                <p class="font-bold">${nutrientsFor100g.calories.toFixed(1)} kcal</p>
                            </div>
                            <div class="bg-blue-100 p-2 rounded">
                                <p class="text-gray-600">Protéines</p>
                                <p class="font-bold">${nutrientsFor100g.protein.toFixed(1)} g</p>
                            </div>
                            <div class="bg-green-100 p-2 rounded">
                                <p class="text-gray-600">Glucides</p>
                                <p class="font-bold">${nutrientsFor100g.carbs.toFixed(1)} g</p>
                            </div>
                            <div class="bg-orange-100 p-2 rounded">
                                <p class="text-gray-600">Lipides</p>
                                <p class="font-bold">${nutrientsFor100g.fat.toFixed(1)} g</p>
                            </div>
                        </div>
                    `;

                     // Afficher les micronutriments pour 100g s'ils existent
                    if (nutrientsFor100g.micro && Object.keys(nutrientsFor100g.micro).length > 0) {
                        detailsHTML += `<div class="mt-4"><p class="font-medium text-gray-700 mb-2 text-sm">Micronutriments (pour ${displayQuantity}g):</p><ul class="text-xs space-y-1">`;
                        // Trier les micronutriments pour un affichage cohérent
                        const sortedMicros = Object.entries(nutrientsFor100g.micro).sort((a, b) => a[0].localeCompare(b[0]));
                        sortedMicros.forEach(([nutrient, details]) => {
                            detailsHTML += `<li class="text-gray-600">${nutrient}: ${details.value.toFixed(1)} ${details.unit}</li>`;
                        });
                        detailsHTML += `</ul></div>`;
                    }

                    foodDetailsContent.innerHTML = detailsHTML;
                    addFoodBtn.disabled = false; // Activer le bouton seulement si un aliment est sélectionné
                } else {
                    foodDetailsContent.innerHTML = '<p class="text-gray-500 italic text-sm">Sélectionnez un aliment pour voir ses détails nutritionnels (pour 100g).</p>';
                    addFoodBtn.disabled = true; // Désactiver le bouton
                }
            }


            function addFoodToMeal() {
                const category = categorySelect.value;
                const foodName = foodSelect.value;
                const quantity = parseInt(quantityInput.value);

                if (!category || !foodName) {
                    alert("Veuillez sélectionner une catégorie et un aliment.");
                    return;
                }
                if (isNaN(quantity) || quantity <= 0) {
                     alert("Veuillez entrer une quantité valide (supérieure à 0).");
                    return;
                }
                if (foodDatabase[category] && foodDatabase[category][foodName]) {
                    const food = foodDatabase[category][foodName];
                    const calculatedNutrients = calculateNutrients(food, quantity);

                    const mealItem = {
                        id: Date.now() + Math.random(), // ID unique plus robuste
                        category: category,
                        name: foodName,
                        quantity: quantity,
                        ...calculatedNutrients // Utilise le spread operator
                    };

                    meals[activeMeal].items.push(mealItem);

                    updateMealList();
                    updateNutritionSummary();
                    updateDailySummary();

                    // Optionnel: Réinitialiser la sélection après ajout
                    // foodSelect.value = '';
                    // quantityInput.value = '100';
                    // updateFoodDetails(); // Met à jour les détails pour afficher le message par défaut
                    // categorySelect.value = ''; // Déselectionne aussi la catégorie
                    // foodSelect.disabled = true;

                } else {
                    console.error("Aliment non trouvé dans la base de données:", category, foodName);
                    alert("Erreur : Aliment non trouvé.");
                }
            }

            function updateMealList() {
                if (!mealList || !emptyMealMessage) return; // Sécurité

                const currentMealItems = meals[activeMeal]?.items || [];

                if (currentMealItems.length > 0) {
                    emptyMealMessage.style.display = 'none';
                    mealList.innerHTML = ''; // Vider la liste existante

                    currentMealItems.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'py-3';
                        li.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-medium text-gray-800">${item.name}</span>
                                    <span class="text-sm text-gray-500 ml-2">(${item.quantity}g)</span>
                                </div>
                                <div class="flex items-center space-x-2"> <!-- Utilisation de space-x -->
                                    <span class="text-sm font-semibold mr-2">${item.calories.toFixed(0)} kcal</span>
                                    <button class="edit-item-btn text-blue-500 hover:text-blue-700 no-print p-1" data-meal-key="${activeMeal}" data-item-id="${item.id}" aria-label="Modifier ${item.name}">
                                        <i class="fas fa-edit fa-fw"></i> <!-- fa-fw pour largeur fixe -->
                                    </button>
                                    <button class="remove-item-btn text-red-500 hover:text-red-700 no-print p-1" data-meal-key="${activeMeal}" data-item-id="${item.id}" aria-label="Supprimer ${item.name}">
                                        <i class="fas fa-trash-alt fa-fw"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mt-1 text-xs">
                                <span class="text-blue-600 mr-2">P: ${item.protein.toFixed(1)}g</span>
                                <span class="text-green-600 mr-2">G: ${item.carbs.toFixed(1)}g</span>
                                <span class="text-orange-600">L: ${item.fat.toFixed(1)}g</span>
                            </div>
                        `;
                        mealList.appendChild(li);
                    });
                } else {
                    emptyMealMessage.style.display = 'block';
                    mealList.innerHTML = ''; // Assurer que la liste est vide
                }
            }

             function handleMealItemAction(event) {
                const target = event.target;
                const removeButton = target.closest('.remove-item-btn');
                const editButton = target.closest('.edit-item-btn');

                if (removeButton) {
                    const mealKey = removeButton.dataset.mealKey;
                    const itemId = parseInt(removeButton.dataset.itemId);
                    if (mealKey && !isNaN(itemId) && meals[mealKey]) {
                         handleRemoveItem(mealKey, itemId);
                    }
                } else if (editButton) {
                    const mealKey = editButton.dataset.mealKey;
                    const itemId = parseInt(editButton.dataset.itemId);
                     if (mealKey && !isNaN(itemId) && meals[mealKey]) {
                         handleEditItem(mealKey, itemId);
                     }
                }
            }

            function handleRemoveItem(mealKey, id) {
                 // Ajouter une confirmation
                 if (confirm(`Voulez-vous vraiment supprimer cet élément ?`)) {
                    meals[mealKey].items = meals[mealKey].items.filter(item => item.id !== id);

                    if (mealKey === activeMeal) {
                        updateMealList();
                        updateNutritionSummary();
                    }
                    updateDailySummary();
                }
            }

            function handleEditItem(mealKey, id) {
                const item = meals[mealKey]?.items.find(item => item.id === id);
                if (item) {
                    currentEditId = id;
                    currentEditMeal = mealKey;
                    editQuantity.value = item.quantity;
                    editModalTitle.textContent = `Modifier quantité: ${item.name}`;
                    openModal(editModal);
                    editQuantity.focus(); // Mettre le focus sur l'input
                    editQuantity.select(); // Sélectionner le contenu
                } else {
                    console.error("Élément à éditer non trouvé:", mealKey, id);
                }
            }

            function confirmEdit() {
                if (currentEditId !== null && currentEditMeal !== null) {
                    const newQuantity = parseInt(editQuantity.value);

                    if (!isNaN(newQuantity) && newQuantity > 0) {
                        const itemIndex = meals[currentEditMeal].items.findIndex(item => item.id === currentEditId);

                        if (itemIndex !== -1) {
                            const item = meals[currentEditMeal].items[itemIndex];
                            const foodData = foodDatabase[item.category]?.[item.name];

                            if (foodData) {
                                const updatedNutrients = calculateNutrients(foodData, newQuantity);
                                // Mettre à jour l'objet item
                                meals[currentEditMeal].items[itemIndex] = {
                                    ...item, // Garde l'ID, category, name
                                    quantity: newQuantity,
                                    ...updatedNutrients // Met à jour calories, protein, etc.
                                };

                                // Mettre à jour l'affichage
                                if (currentEditMeal === activeMeal) {
                                    updateMealList();
                                    updateNutritionSummary();
                                }
                                updateDailySummary();
                            } else {
                                console.error("Données de l'aliment non trouvées pour la mise à jour:", item.category, item.name);
                                alert("Erreur: impossible de trouver les données de l'aliment pour la mise à jour.");
                            }
                        }
                    } else {
                         alert("Veuillez entrer une quantité valide (nombre entier positif).");
                         return; // Ne pas fermer la modale si la valeur est invalide
                    }
                }
                // Fermer la modale et réinitialiser
                closeModal(editModal);
                currentEditId = null;
                currentEditMeal = null;
            }


            function updateNutritionSummary() {
                 const currentMealItems = meals[activeMeal]?.items || [];

                 let totalCal = 0, totalP = 0, totalC = 0, totalF = 0, totalW = 0;
                 let microTotals = {};

                 currentMealItems.forEach(item => {
                    totalCal += item.calories;
                    totalP += item.protein;
                    totalC += item.carbs;
                    totalF += item.fat;
                    totalW += item.quantity;

                    // Additionner les micronutriments
                    for (const [nutrient, details] of Object.entries(item.micro || {})) {
                        if (!microTotals[nutrient]) {
                            microTotals[nutrient] = { value: 0, unit: details.unit };
                        }
                        microTotals[nutrient].value += details.value;
                    }
                 });

                 // Calculer les calories des macros
                 const proteinCal = totalP * 4;
                 const carbsCal = totalC * 4;
                 const fatCal = totalF * 9;
                 const totalMacroCal = proteinCal + carbsCal + fatCal;

                 // Calculer les pourcentages (éviter division par zéro)
                 const proteinPerc = totalMacroCal > 0 ? (proteinCal / totalMacroCal * 100) : 0;
                 const carbsPerc = totalMacroCal > 0 ? (carbsCal / totalMacroCal * 100) : 0;
                 const fatPerc = totalMacroCal > 0 ? (fatCal / totalMacroCal * 100) : 0;

                 // Mettre à jour l'affichage des totaux et pourcentages
                 totalCalories.textContent = `${totalCal.toFixed(0)} kcal`;
                 totalWeight.textContent = `${totalW} g`;
                 totalProtein.textContent = `${totalP.toFixed(1)}g (${proteinPerc.toFixed(0)}%)`;
                 totalCarbs.textContent = `${totalC.toFixed(1)}g (${carbsPerc.toFixed(0)}%)`;
                 totalFat.textContent = `${totalF.toFixed(1)}g (${fatPerc.toFixed(0)}%)`;

                 // Mettre à jour les barres de progression
                 proteinBar.style.width = `${proteinPerc}%`;
                 carbsBar.style.width = `${carbsPerc}%`;
                 fatBar.style.width = `${fatPerc}%`;

                 // Mettre à jour le graphique du repas
                 updateChart(proteinCal, carbsCal, fatCal);

                 // Afficher les micronutriments
                 if (micronutrientsContainer && emptyMicroMessage) {
                    if (Object.keys(microTotals).length > 0) {
                        emptyMicroMessage.style.display = 'none';
                        let microHTML = '<div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs">'; // Grid pour meilleure disposition
                        const sortedMicros = Object.entries(microTotals).sort((a, b) => a[0].localeCompare(b[0]));

                        sortedMicros.forEach(([nutrient, details]) => {
                            // Ajout d'une barre indicative simple (optionnel)
                            microHTML += `
                                <div class="mb-1">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">${nutrient}</span>
                                        <span class="font-medium">${details.value.toFixed(1)} ${details.unit}</span>
                                    </div>
                                     <div class="w-full bg-gray-200 rounded-full h-1 mt-0.5">
                                         <div class="bg-purple-400 h-1 rounded-full" style="width: ${Math.min(100, details.value)}%"></div> <!-- Barre indicative simple -->
                                     </div>
                                </div>
                            `;
                        });
                        microHTML += '</div>';
                        micronutrientsContainer.innerHTML = microHTML;
                    } else {
                        emptyMicroMessage.style.display = 'block';
                        micronutrientsContainer.innerHTML = ''; // Vider au cas où
                    }
                 }
            }

            function updateDailySummary() {
                let totalDailyCal = 0, totalDailyP = 0, totalDailyC = 0, totalDailyF = 0;
                let mealCaloriesData = {}; // Pour le graphique des repas

                // Itérer sur tous les repas définis dans 'meals'
                for (const [mealKey, meal] of Object.entries(meals)) {
                    let mealCal = 0, mealP = 0, mealC = 0, mealF = 0;

                    meal.items.forEach(item => {
                        mealCal += item.calories;
                        mealP += item.protein;
                        mealC += item.carbs;
                        mealF += item.fat;
                    });

                    // Mettre à jour le tableau récapitulatif
                    document.getElementById(`${mealKey}-calories`).textContent = `${mealCal.toFixed(0)} kcal`;
                    document.getElementById(`${mealKey}-protein`).textContent = `${mealP.toFixed(1)} g`;
                    document.getElementById(`${mealKey}-carbs`).textContent = `${mealC.toFixed(1)} g`;
                    document.getElementById(`${mealKey}-fat`).textContent = `${mealF.toFixed(1)} g`;

                    // Cumuler pour les totaux journaliers
                    totalDailyCal += mealCal;
                    totalDailyP += mealP;
                    totalDailyC += mealC;
                    totalDailyF += mealF;

                    // Stocker pour le graphique des repas (utiliser le nom du repas)
                    mealCaloriesData[meal.name] = mealCal;
                }

                // Mettre à jour les cartes de résumé journalier
                document.getElementById('daily-calories').textContent = `${totalDailyCal.toFixed(0)} kcal`;
                document.getElementById('daily-protein').textContent = `${totalDailyP.toFixed(1)} g`;
                document.getElementById('daily-carbs').textContent = `${totalDailyC.toFixed(1)} g`;
                document.getElementById('daily-fat').textContent = `${totalDailyF.toFixed(1)} g`;

                // Mettre à jour la ligne TOTAL du tableau
                document.getElementById('total-daily-calories').textContent = `${totalDailyCal.toFixed(0)} kcal`;
                document.getElementById('total-daily-protein').textContent = `${totalDailyP.toFixed(1)} g`;
                document.getElementById('total-daily-carbs').textContent = `${totalDailyC.toFixed(1)} g`;
                document.getElementById('total-daily-fat').textContent = `${totalDailyF.toFixed(1)} g`;

                // Mettre à jour les graphiques journaliers
                const proteinCal = totalDailyP * 4;
                const carbsCal = totalDailyC * 4;
                const fatCal = totalDailyF * 9;
                updateDailyMacroChart(proteinCal, carbsCal, fatCal);
                updateMealsChart(mealCaloriesData);
            }

            function initCharts() {
                Chart.defaults.font.family = "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif"; // Police plus standard
                Chart.defaults.font.size = 11; // Taille par défaut légèrement réduite
                Chart.defaults.color = '#6b7280'; // Couleur de police par défaut (gris Tailwind)

                const commonDoughnutOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%', // Fait un trou plus grand
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15, // Espace entre les légendes
                                usePointStyle: true, // Utilise des cercles au lieu de rectangles
                                boxWidth: 8, // Taille des points
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleFont: { size: 12 },
                            bodyFont: { size: 11 },
                            padding: 8,
                            cornerRadius: 4,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${percentage}% (${value.toFixed(0)} kcal)`;
                                }
                            }
                        }
                    }
                };

                // Graphique Macronutriments du Repas
                const macroCtx = document.getElementById('macro-chart')?.getContext('2d');
                if (macroCtx) {
                    macroChart = new Chart(macroCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Protéines', 'Glucides', 'Lipides'],
                            datasets: [{
                                data: [1, 1, 1], // Initialiser avec des valeurs non nulles pour voir le rendu
                                backgroundColor: ['#4299e1', '#48bb78', '#ed8936'],
                                hoverBackgroundColor: ['#3182ce', '#38a169', '#dd6b20'], // Couleur au survol
                                borderWidth: 0, // Pas de bordure
                                hoverOffset: 8 // Effet léger au survol
                            }]
                        },
                        options: commonDoughnutOptions
                    });
                } else { console.error("Canvas 'macro-chart' non trouvé."); }

                // Graphique Macronutriments Journaliers
                const dailyMacroCtx = document.getElementById('daily-macro-chart')?.getContext('2d');
                 if (dailyMacroCtx) {
                    dailyMacroChart = new Chart(dailyMacroCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Protéines', 'Glucides', 'Lipides'],
                            datasets: [{
                                data: [1, 1, 1],
                                backgroundColor: ['#63b3ed', '#68d391', '#f6ad55'], // Nuances légèrement différentes
                                hoverBackgroundColor: ['#4299e1', '#48bb78', '#ed8936'],
                                borderWidth: 0,
                                hoverOffset: 8
                            }]
                        },
                        options: commonDoughnutOptions
                    });
                 } else { console.error("Canvas 'daily-macro-chart' non trouvé."); }

                // Graphique Répartition par Repas
                const mealsCtx = document.getElementById('meals-chart')?.getContext('2d');
                if (mealsCtx) {
                    mealsChart = new Chart(mealsCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Petit-déj.', 'Déjeuner', 'Dîner', 'Collation'], // Labels raccourcis
                            datasets: [{
                                label: 'Calories (kcal)',
                                data: [0, 0, 0, 0],
                                backgroundColor: [
                                    'rgba(66, 153, 225, 0.6)',  // Bleu
                                    'rgba(72, 187, 120, 0.6)',  // Vert
                                    'rgba(237, 137, 54, 0.6)', // Orange
                                    'rgba(159, 122, 234, 0.6)'  // Violet
                                ],
                                borderColor: [ // Bordures plus foncées
                                    'rgba(49, 130, 206, 1)',
                                    'rgba(56, 161, 105, 1)',
                                    'rgba(221, 107, 32, 1)',
                                    'rgba(128, 90, 213, 1)'
                                ],
                                borderWidth: 1,
                                borderRadius: 4, // Coins arrondis
                                barPercentage: 0.7, // Barres moins larges
                                categoryPercentage: 0.8 // Moins d'espace entre groupes
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }, // Pas besoin de légende pour une seule série
                                tooltip: {
                                     backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                     titleFont: { size: 12 }, bodyFont: { size: 11 }, padding: 8, cornerRadius: 4,
                                     callbacks: {
                                         label: (context) => `${context.raw.toFixed(0)} kcal`
                                     }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: '#e2e8f0' }, // Lignes de grille plus claires
                                    title: {
                                        display: true,
                                        text: 'Calories (kcal)',
                                        font: { size: 10 },
                                        padding: { top: 0, bottom: 5 }
                                    },
                                     ticks: { font: { size: 10 } }
                                },
                                x: {
                                     grid: { display: false }, // Pas de grille verticale
                                     ticks: { font: { size: 10 } }
                                }
                            }
                        }
                    });
                } else { console.error("Canvas 'meals-chart' non trouvé."); }
            }

            function updateChart(protein, carbs, fat) {
                if (macroChart) {
                    macroChart.data.datasets[0].data = [protein, carbs, fat];
                    macroChart.update('none'); // 'none' pour éviter l'animation si non désiré
                }
            }

            function updateDailyMacroChart(protein, carbs, fat) {
                if (dailyMacroChart) {
                    dailyMacroChart.data.datasets[0].data = [protein, carbs, fat];
                    dailyMacroChart.update('none');
                }
            }

            function updateMealsChart(mealCalories) {
                if (mealsChart) {
                     // Assurez-vous que les clés correspondent aux labels du graphique
                     const data = [
                        mealCalories['Petit-déjeuner'] || 0,
                        mealCalories['Déjeuner'] || 0,
                        mealCalories['Dîner'] || 0,
                        mealCalories['Collation'] || 0
                     ];
                    mealsChart.data.datasets[0].data = data;
                    mealsChart.update(); // Laisser l'animation ici peut être bien
                }
            }

             function resetAllMeals() {
                 // Utiliser une modale custom serait mieux, mais confirm() est simple
                 if (confirm('Voulez-vous vraiment réinitialiser tous les repas de la journée ? Cette action est irréversible.')) {
                     for (const mealKey in meals) {
                         if (meals.hasOwnProperty(mealKey)) {
                             meals[mealKey].items = [];
                         }
                     }

                     // Assurer que le premier onglet est actif
                     activeMeal = mealTabs.length > 0 ? mealTabs[0].dataset.meal : 'breakfast';
                     updateActiveTab(); // Mettre à jour l'onglet visuellement

                     updateMealList();
                     updateNutritionSummary(); // Met à jour le résumé du repas actif (vide)
                     updateDailySummary(); // Met à jour le résumé journalier (tout à zéro)
                     updateMealTitles();   // Met à jour les titres H2

                     // Optionnel: Déplier la section d'ajout manuel si elle était repliée
                     if (addFoodContent && addFoodContent.classList.contains('collapsed')) {
                        toggleSection(addFoodContent, addFoodToggleIcon, toggleAddFoodBtn);
                     }
                 }
             }


            function addToHome() {
                // Fonction PWA (Progressive Web App) basique
                // Nécessite un Manifest et un Service Worker pour fonctionner réellement
                alert("Pour ajouter à l'écran d'accueil :\n\nSur iOS : Touchez l'icône Partager puis 'Sur l'écran d'accueil'.\nSur Android : Touchez les trois points du navigateur puis 'Ajouter à l'écran d'accueil'.");
                // Idéalement, détecter si l'app peut être installée et montrer un bouton différent
            }

            function exportToPDF() {
                // Préparation du contenu pour PDF
                const today = new Date();
                const dateStr = today.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });

                const pdfContainer = document.createElement('div');
                pdfContainer.style.fontFamily = 'Arial, sans-serif';
                pdfContainer.style.padding = '20px';
                pdfContainer.style.fontSize = '10pt'; // Taille pour impression

                 // En-tête
                 pdfContainer.innerHTML = `
                    <div style="text-align: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px;">
                        <h1 style="font-size: 16pt; color: #2c5282; margin: 0;">Menu Journalier Détaillé</h1>
                        <p style="font-size: 9pt; color: #555; margin-top: 5px;">Date: ${dateStr}</p>
                    </div>
                `;

                 // Résumé Global
                 const summaryDiv = document.createElement('div');
                 summaryDiv.style.backgroundColor = '#f7fafc';
                 summaryDiv.style.border = '1px solid #e2e8f0';
                 summaryDiv.style.borderRadius = '6px';
                 summaryDiv.style.padding = '15px';
                 summaryDiv.style.marginBottom = '25px';
                 summaryDiv.innerHTML = `<h2 style="font-size: 12pt; color: #2d3748; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">Résumé Nutritionnel Journalier</h2>`;

                 const summaryGrid = document.createElement('div');
                 summaryGrid.style.display = 'grid';
                 summaryGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(120px, 1fr))'; // Responsive
                 summaryGrid.style.gap = '15px';

                 const totalCalPDF = parseFloat(document.getElementById('daily-calories')?.textContent || '0');
                 const totalProtPDF = parseFloat(document.getElementById('daily-protein')?.textContent || '0');
                 const totalCarbPDF = parseFloat(document.getElementById('daily-carbs')?.textContent || '0');
                 const totalFatPDF = parseFloat(document.getElementById('daily-fat')?.textContent || '0');

                 summaryGrid.innerHTML = `
                    <div style="text-align: center; background-color: #ebf8ff; padding: 10px; border-radius: 4px;">
                        <strong style="font-size: 9pt; color: #3182ce;">Calories</strong><br>
                        <span style="font-size: 14pt; font-weight: bold;">${totalCalPDF.toFixed(0)} kcal</span>
                    </div>
                    <div style="text-align: center; background-color: #e6fffa; padding: 10px; border-radius: 4px;">
                        <strong style="font-size: 9pt; color: #38a169;">Protéines</strong><br>
                        <span style="font-size: 14pt; font-weight: bold;">${totalProtPDF.toFixed(1)} g</span>
                    </div>
                    <div style="text-align: center; background-color: #fffaf0; padding: 10px; border-radius: 4px;">
                        <strong style="font-size: 9pt; color: #dd6b20;">Glucides</strong><br>
                        <span style="font-size: 14pt; font-weight: bold;">${totalCarbPDF.toFixed(1)} g</span>
                    </div>
                    <div style="text-align: center; background-color: #fff5f5; padding: 10px; border-radius: 4px;">
                        <strong style="font-size: 9pt; color: #c53030;">Lipides</strong><br>
                        <span style="font-size: 14pt; font-weight: bold;">${totalFatPDF.toFixed(1)} g</span>
                    </div>
                 `;
                 summaryDiv.appendChild(summaryGrid);
                 pdfContainer.appendChild(summaryDiv);

                 // Détail par repas
                 for (const [mealKey, meal] of Object.entries(meals)) {
                    if (meal.items.length > 0) { // N'afficher que les repas non vides
                        const mealDiv = document.createElement('div');
                        mealDiv.style.marginBottom = '25px';
                        mealDiv.style.pageBreakInside = 'avoid'; // Essayer d'éviter coupure au milieu d'un repas

                        let mealIconHTML = ''; // Pas d'icônes FontAwesome dans le PDF simple
                        // Retrouver le nom correct
                        const mealNamePDF = meals[mealKey]?.name || mealKey;

                        let mealContent = `<h2 style="font-size: 12pt; color: #2d3748; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 4px;">${mealIconHTML}${mealNamePDF}</h2>`;

                        let totalMealCal = 0, totalMealProt = 0, totalMealCarbs = 0, totalMealFat = 0;

                        mealContent += `<table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                            <thead>
                                <tr style="text-align: left; background-color: #f8fafc;">
                                    <th style="padding: 6px 4px; border-bottom: 1px solid #ddd;">Aliment</th>
                                    <th style="padding: 6px 4px; border-bottom: 1px solid #ddd; text-align: right;">Qté (g)</th>
                                    <th style="padding: 6px 4px; border-bottom: 1px solid #ddd; text-align: right;">Kcal</th>
                                    <th style="padding: 6px 4px; border-bottom: 1px solid #ddd; text-align: right;">P (g)</th>
                                    <th style="padding: 6px 4px; border-bottom: 1px solid #ddd; text-align: right;">G (g)</th>
                                    <th style="padding: 6px 4px; border-bottom: 1px solid #ddd; text-align: right;">L (g)</th>
                                </tr>
                            </thead><tbody>`;

                        meal.items.forEach(item => {
                            totalMealCal += item.calories;
                            totalMealProt += item.protein;
                            totalMealCarbs += item.carbs;
                            totalMealFat += item.fat;
                            mealContent += `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 5px 4px;">${item.name}</td>
                                    <td style="padding: 5px 4px; text-align: right;">${item.quantity}</td>
                                    <td style="padding: 5px 4px; text-align: right;">${item.calories.toFixed(0)}</td>
                                    <td style="padding: 5px 4px; text-align: right;">${item.protein.toFixed(1)}</td>
                                    <td style="padding: 5px 4px; text-align: right;">${item.carbs.toFixed(1)}</td>
                                    <td style="padding: 5px 4px; text-align: right;">${item.fat.toFixed(1)}</td>
                                </tr>`;
                        });

                         // Ligne Total du repas
                         mealContent += `
                            <tr style="background-color: #f8fafc; font-weight: bold;">
                                <td style="padding: 6px 4px;">Total ${mealNamePDF}</td>
                                <td style="padding: 6px 4px;"></td>
                                <td style="padding: 6px 4px; text-align: right;">${totalMealCal.toFixed(0)}</td>
                                <td style="padding: 6px 4px; text-align: right;">${totalMealProt.toFixed(1)}</td>
                                <td style="padding: 6px 4px; text-align: right;">${totalMealCarbs.toFixed(1)}</td>
                                <td style="padding: 6px 4px; text-align: right;">${totalMealFat.toFixed(1)}</td>
                            </tr>
                         </tbody></table>`;

                         mealDiv.innerHTML = mealContent;
                         pdfContainer.appendChild(mealDiv);
                    }
                 }

                 // Pied de page
                 const footer = document.createElement('div');
                 footer.style.marginTop = '30px';
                 footer.style.paddingTop = '10px';
                 footer.style.borderTop = '1px solid #ccc';
                 footer.style.textAlign = 'center';
                 footer.style.fontSize = '8pt';
                 footer.style.color = '#777';
                 footer.innerHTML = `
                    <p>Généré par le Calculateur de Calories - Tophe (${today.getFullYear()})</p>
                    <p>Les valeurs nutritionnelles sont des estimations basées sur des données moyennes et peuvent varier.</p>
                    <p><strong>Ce document ne remplace pas l'avis d'un professionnel de la nutrition ou de la santé.</strong></p>
                `;
                 pdfContainer.appendChild(footer);


                // Options pour html2pdf
                const opt = {
                    margin: [10, 10, 10, 10], // [top, left, bottom, right] en mm
                    filename: `Menu_Journalier_${today.toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: {
                        scale: 2, // Améliore la résolution
                        useCORS: true, // Si vous chargez des images externes
                        logging: false // Moins de logs console
                     },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Générer le PDF
                 html2pdf().set(opt).from(pdfContainer).save();

            }

            // --- FONCTIONS POUR LA GÉNÉRATION AUTOMATIQUE ---

            function isPrimaryProteinSource(foodInfo) {
                if (!foodInfo || !foodInfo.category || !foodInfo.name) return false;
                const proteinCats = ['viandes', 'poissons'];
                const highProteinDairy = ['Fromage blanc 0%', 'Skyr', 'Yaourt grec', 'Cottage cheese'];
                const highProteinBreakfast = ['Œuf (entier)', 'Bacon'];
                const highProteinLegumes = ['Lentilles (cuites)', 'Pois Chiche (cuits)', 'Haricot Rouge (cuit)'];

                return proteinCats.includes(foodInfo.category) ||
                       (foodInfo.category === 'produits_laitiers' && highProteinDairy.includes(foodInfo.name)) ||
                       (foodInfo.category === 'petit_dejeuner' && highProteinBreakfast.includes(foodInfo.name)) ||
                       (foodInfo.category === 'feculents' && highProteinLegumes.includes(foodInfo.name));
            }

            function generateSingleMeal(mealKey, targetCalories, config, excludeProtein = null, objective = 'maintain') {
                let selectedItems = [];
                let chosenProtein = null;
                let tempSelectedFoods = [];

                // 1. Sélection des Aliments
                if (config.type === 'random') {
                     const minItems=config.minItems||2, maxItems=config.maxItems||4;
                     const numItemsToSelect=Math.floor(Math.random()*(maxItems-minItems+1))+minItems;
                     let availableFoods=[];
                     config.categories.forEach(catKey=>{
                         if(foodDatabase[catKey]){
                            Object.keys(foodDatabase[catKey]).forEach(foodName=>{availableFoods.push({category:catKey,name:foodName,data:foodDatabase[catKey][foodName]})})
                         } else { console.warn(`Catégorie ${catKey} non trouvée dans foodDatabase pour ${mealKey}`); }
                     });
                     if(availableFoods.length===0){console.warn(`Aucun aliment dispo pour ${mealKey} (random)`);return null}
                     for(let i=0;i<numItemsToSelect&&availableFoods.length>0;i++){
                         const randomIndex=Math.floor(Math.random()*availableFoods.length);
                         tempSelectedFoods.push(availableFoods[randomIndex]);
                         availableFoods.splice(randomIndex,1);
                     }
                } else if (config.type === 'structured') {
                     for(const partKey in config.structure){
                         const partConfig=config.structure[partKey];
                         let availablePartFoods=[];
                         partConfig.cats.forEach(catKey=>{
                            if(foodDatabase[catKey]){
                               Object.keys(foodDatabase[catKey]).forEach(foodName=>{availablePartFoods.push({category:catKey,name:foodName,data:foodDatabase[catKey][foodName]})})
                            } else { console.warn(`Catégorie ${catKey} non trouvée dans foodDatabase pour partie ${partKey} de ${mealKey}`); }
                         });
                         if(partKey==='protein'&&excludeProtein&&availablePartFoods.length>1){
                             availablePartFoods=availablePartFoods.filter(food=>!(food.category===excludeProtein.category&&food.name===excludeProtein.name))
                         }
                         if(availablePartFoods.length>0){
                             const count=partConfig.count||1;
                             for(let i=0;i<count;i++){
                                 if(availablePartFoods.length===0)break;
                                 if(partConfig.optional&&tempSelectedFoods.length>0&&Math.random()<0.4){continue}
                                 const randomIndex=Math.floor(Math.random()*availablePartFoods.length);
                                 const selectedFood=availablePartFoods[randomIndex];
                                 tempSelectedFoods.push(selectedFood);
                                 if(partKey==='protein'){chosenProtein={category:selectedFood.category,name:selectedFood.name}}
                                 availablePartFoods.splice(randomIndex,1)
                              }
                         } else if(!partConfig.optional){
                             console.warn(`Aucun aliment dispo pour partie obligatoire '${partKey}' de ${mealKey}`);
                         }
                     }
                }
                if (tempSelectedFoods.length === 0) { console.warn(`Aucun aliment sélectionné pour ${mealKey}`); return null; }

                // 2. Quantités Initiales
                let initialTotalCalories = 0;
                tempSelectedFoods.forEach(foodInfo => {
                     let initialQuantity=100;
                     // Logique d'ajustement quantité initiale (simplifiée)
                     if(foodInfo.category==='assaisonnement') initialQuantity = (foodInfo.name.toLowerCase().includes('huile')) ? 10 : 20;
                     else if(foodInfo.category==='boissons' && foodInfo.data.calories < 10) initialQuantity = 200;
                     else if(foodInfo.category==='fruits' && (foodInfo.name.includes('Noix')||foodInfo.name.includes('Amandes')||foodInfo.name.includes('Noisettes'))) initialQuantity = 30;
                     else if(foodInfo.category==='produits_laitiers' && foodInfo.data.calories < 70) initialQuantity = 150;
                     else if(foodInfo.category==='cereales' && foodInfo.name.includes('Pain')) initialQuantity = 50;
                     else if(foodInfo.category==='cereales') initialQuantity = 40;
                     else if(foodInfo.category==='feculents' && foodInfo.name.includes('Pain')) initialQuantity = 60;
                     else if(foodInfo.category==='legumes' && foodInfo.data.calories < 30) initialQuantity = 150;
                     else if(foodInfo.category==='viandes'||foodInfo.category==='poissons') initialQuantity = 120;
                     else if(foodInfo.category==='feculents') initialQuantity = 150;
                     else if(foodInfo.category==='petit_dejeuner' && foodInfo.name.includes('Œuf')) initialQuantity = 60; // env 1 oeuf

                     const foodCaloriesPer100g=foodInfo.data.calories||0;
                     initialTotalCalories+=(foodCaloriesPer100g*initialQuantity/100);
                     selectedItems.push({foodInfo:foodInfo,quantity:initialQuantity})
                });

                 // 3. Ajustement des Quantités basé sur objectif et calories cibles
                 if (initialTotalCalories > 0 && targetCalories > 0) {
                     const baseAdjustmentFactor = targetCalories / initialTotalCalories;
                     selectedItems.forEach(item => {
                         let objectiveFactor = 1.0;
                         if (objective === 'gainMuscle' && isPrimaryProteinSource(item.foodInfo)) {
                             objectiveFactor = 1.20; // +20% Protéines pour prise de muscle
                         } else if (objective === 'loseWeight' && !isPrimaryProteinSource(item.foodInfo)) {
                              objectiveFactor = 0.90; // -10% sur non-protéines pour perte poids (léger)
                         }
                         // Ne pas trop réduire les petites quantités (assaisonnements, etc.)
                         const isSmallPortion = (item.foodInfo.category === 'assaisonnement' || item.foodInfo.category === 'boissons' || item.quantity < 30);
                         const finalAdjustment = isSmallPortion ? baseAdjustmentFactor : baseAdjustmentFactor * objectiveFactor;

                         let newQuantity = Math.max(5, Math.round(item.quantity * finalAdjustment)); // Min 5g
                         // Arrondir aux 5g près pour plus de réalisme
                         newQuantity = Math.round(newQuantity / 5) * 5;
                         item.quantity = Math.max(5, newQuantity); // Assurer un minimum après arrondi
                     });
                 } else if (targetCalories <= 0) {
                     selectedItems.forEach(item => item.quantity = Math.round(item.quantity / 2)); // Réduire si 0 cal visées
                 }

                // 4. Ajout au Repas Global 'meals'
                selectedItems.forEach(item => {
                    const food=item.foodInfo.data;
                    const quantity=item.quantity;
                    const category=item.foodInfo.category;
                    const foodName=item.foodInfo.name;
                    if(!food||quantity<=0)return;

                    const calculatedNutrients = calculateNutrients(food, quantity);
                    const mealItem={
                        id:Date.now()+Math.random(),
                        category:category,
                        name:foodName,
                        quantity:quantity,
                        ...calculatedNutrients
                    };

                    if(meals[mealKey]?.items){
                        meals[mealKey].items.push(mealItem);
                    }else{console.error(`Repas ${mealKey} invalide lors de l'ajout d'item.`)}
                });

                return chosenProtein;
            }

            function generateFullDayMenu() {
                const totalTargetCalories = parseInt(targetCaloriesInput.value);
                generationFeedback.textContent = ''; // Nettoyer feedback précédent

                const selectedObjectiveRadio = document.querySelector('input[name="diet-objective"]:checked');
                const selectedObjective = selectedObjectiveRadio ? selectedObjectiveRadio.value : 'maintain';

                if (isNaN(totalTargetCalories) || totalTargetCalories <= 500) { // Augmenter minimum raisonnable
                    generationFeedback.textContent = 'Veuillez entrer un total calorique journalier valide (minimum 500 kcal).';
                    return;
                }

                const objectiveText = {
                    maintain: 'Maintien',
                    loseWeight: 'Perte de poids',
                    gainMuscle: 'Prise de muscle'
                }[selectedObjective];

                generationFeedback.innerHTML = `
                    <p class="font-semibold text-orange-600">Génération en cours (Objectif: ${objectiveText})...</p>
                    <p class="mt-2 text-gray-600 text-xs">
                        <i class="fas fa-exclamation-triangle mr-1 text-yellow-500"></i>
                        <strong>Attention :</strong> Ce menu est généré aléatoirement pour approcher les calories cibles et l'objectif choisi. Il n'est PAS garanti d'être parfaitement équilibré, varié ou gustativement cohérent. Utilisez-le comme point de départ et adaptez-le. Consultez toujours un professionnel pour un plan nutritionnel personnalisé.
                    </p>`;

                // Utiliser une modale custom serait mieux que confirm()
                if (confirm('Générer un nouveau menu écrasera tous les repas actuellement saisis. Continuer ?')) {
                    // --- Réinitialisation ---
                    for (const mealKey in meals) { meals[mealKey].items = []; }
                     activeMeal = mealTabs.length > 0 ? mealTabs[0].dataset.meal : 'breakfast';
                     updateActiveTab();
                     updateMealList(); updateNutritionSummary(); updateDailySummary(); updateMealTitles();


                    // --- Configuration (Ajuster répartition si besoin) ---
                    const mealTargets = {
                        breakfast: totalTargetCalories * 0.25, // Légèrement moins
                        lunch:     totalTargetCalories * 0.35,
                        dinner:    totalTargetCalories * 0.30,
                        snack:     totalTargetCalories * 0.10  // Un peu plus pour la collation
                    };
                    const mealConfigs = {
                         breakfast: { type: 'random', categories: ['fruits', 'produits_laitiers', 'cereales', 'petit_dejeuner', 'boissons'], minItems: 2, maxItems: 4 },
                         lunch:     { type: 'structured', structure: {
                                        protein: { cats: ['viandes', 'poissons', 'feculents'], count: 1 }, // Ajout feculents (légumineuses)
                                        starch:  { cats: ['feculents'], count: 1 },
                                        veggie:  { cats: ['legumes'], count: 1 },
                                        fat_source: { cats: ['assaisonnement'], count: 1, optional: true } // Source de gras
                                     }},
                         dinner:    { type: 'structured', structure: {
                                        protein: { cats: ['viandes', 'poissons', 'feculents'], count: 1 },
                                        veggie:  { cats: ['legumes'], count: 2 }, // Plus de légumes le soir?
                                        starch:  { cats: ['feculents'], count: 1, optional: true }, // Féculent optionnel?
                                        fat_source: { cats: ['assaisonnement'], count: 1, optional: true }
                                     }},
                         snack:     { type: 'random', categories: ['fruits', 'produits_laitiers', 'cereales', 'boissons'], minItems: 1, maxItems: 2 }
                     };

                     // --- Génération (avec délai pour feedback UI) ---
                     setTimeout(() => {
                        let lunchProteinInfo = null;
                        try {
                            generateSingleMeal('breakfast', mealTargets.breakfast, mealConfigs.breakfast, null, selectedObjective);
                            lunchProteinInfo = generateSingleMeal('lunch', mealTargets.lunch, mealConfigs.lunch, null, selectedObjective);
                            // Passer la protéine du midi pour essayer de varier le soir
                            generateSingleMeal('dinner', mealTargets.dinner, mealConfigs.dinner, lunchProteinInfo, selectedObjective);
                            generateSingleMeal('snack', mealTargets.snack, mealConfigs.snack, null, selectedObjective);

                            // --- Mise à jour finale UI ---
                             updateMealList(); // Important de mettre à jour la liste active
                             updateNutritionSummary();
                             updateDailySummary();
                             generationFeedback.innerHTML += '<p class="mt-2 font-semibold text-green-600">Menu généré avec succès ! Vérifiez et ajustez si nécessaire.</p>';

                            // ***** Replier la section d'ajout manuel *****
                            if (addFoodContent && !addFoodContent.classList.contains('collapsed')) {
                                toggleSection(addFoodContent, addFoodToggleIcon, toggleAddFoodBtn, false); // force collapse
                                console.log("Section d'ajout manuel repliée automatiquement.");
                            }
                            // ***** FIN Repliement *****

                        } catch (error) {
                             console.error("Erreur lors de la génération du menu:", error);
                             generationFeedback.textContent = 'Une erreur est survenue pendant la génération. Veuillez réessayer.';
                        }
                    }, 50); // Court délai pour que le message "Génération en cours" s'affiche

                } else {
                     generationFeedback.textContent = 'Génération annulée par l\'utilisateur.';
                }
            }

            // --- FONCTIONS POUR SECTIONS REPLIABLES ---
             function toggleSection(contentElement, iconElement, buttonElement, expand = null) {
                if (!contentElement || !iconElement || !buttonElement) return;

                const shouldBeCollapsed = (expand === null) ? !contentElement.classList.contains('collapsed') : !expand;

                if (shouldBeCollapsed) {
                    contentElement.classList.add('collapsed');
                    iconElement.classList.remove('fa-chevron-up');
                    iconElement.classList.add('fa-chevron-down');
                    buttonElement.setAttribute('aria-expanded', 'false');
                    contentElement.setAttribute('aria-hidden', 'true');
                } else {
                    contentElement.classList.remove('collapsed');
                    iconElement.classList.remove('fa-chevron-down');
                    iconElement.classList.add('fa-chevron-up');
                    buttonElement.setAttribute('aria-expanded', 'true');
                    contentElement.setAttribute('aria-hidden', 'false');
                }
             }

            // --- GESTION DES ONGLETS ---
            function updateActiveTab() {
                 mealTabs.forEach(t => {
                     if (t.dataset.meal === activeMeal) {
                         t.classList.add('active', 'bg-white', 'border-gray-300', 'border-b-transparent'); // Styles onglet actif
                         t.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'border-transparent');
                         t.setAttribute('aria-selected', 'true');
                     } else {
                         t.classList.remove('active', 'bg-white', 'border-gray-300', 'border-b-transparent');
                         t.classList.add('bg-gray-200', 'hover:bg-gray-300', 'border-transparent'); // Styles onglet inactif
                          t.setAttribute('aria-selected', 'false');
                     }
                 });
            }


            // --- ÉCOUTEURS D'ÉVÉNEMENTS ---

            // Onglets de repas
            if (mealTabsContainer) {
                mealTabsContainer.addEventListener('click', (e) => {
                    const tab = e.target.closest('.meal-tab');
                    if (tab && tab.dataset.meal) {
                        activeMeal = tab.dataset.meal;
                        updateActiveTab();
                        updateMealTitles();
                        updateMealList();
                        updateNutritionSummary(); // Mettre à jour le résumé pour le nouvel onglet actif
                    }
                });
            }

            // Sélection catégorie/aliment/quantité
            if(categorySelect) categorySelect.addEventListener('change', updateFoodItems);
            if(foodSelect) foodSelect.addEventListener('change', updateFoodDetails);
            if(quantityInput) quantityInput.addEventListener('input', updateFoodDetails); // Maj détails en temps réel ? Peut-être pas nécessaire. Change le titre des détails seulement.

            // Bouton Ajouter Aliment
            if(addFoodBtn) addFoodBtn.addEventListener('click', addFoodToMeal);

            // Actions sur les items du repas (Edit/Delete) - Délégation
            if(mealList) mealList.addEventListener('click', handleMealItemAction);

            // Bouton Reset
            if(resetAllBtn) resetAllBtn.addEventListener('click', resetAllMeals);

             // Modale Info
            if(infoBtn) infoBtn.addEventListener('click', () => openModal(infoModal));
            if(closeModalBtn) closeModalBtn.addEventListener('click', () => closeModal(infoModal));
            if(closeModalX) closeModalX.addEventListener('click', () => closeModal(infoModal));

            // Modale Edit
            if(confirmEditBtn) confirmEditBtn.addEventListener('click', confirmEdit);
            if(cancelEditBtn) cancelEditBtn.addEventListener('click', () => closeModal(editModal));
            if(closeEditModalX) closeEditModalX.addEventListener('click', () => closeModal(editModal));

            // Bouton Ajouter à l'accueil
            if(addToHomeBtn) addToHomeBtn.addEventListener('click', addToHome);

            // Bouton Export PDF
            if(exportPdfBtn) exportPdfBtn.addEventListener('click', exportToPDF);

            // Bouton Générer Menu
            if(generateMenuBtn) generateMenuBtn.addEventListener('click', generateFullDayMenu);

            // Gestion sections repliables
            if(generatorHeader) generatorHeader.addEventListener('click', () => toggleSection(generatorContent, generatorToggleIcon, toggleGeneratorBtn));
            if(addFoodHeader) addFoodHeader.addEventListener('click', () => toggleSection(addFoodContent, addFoodToggleIcon, toggleAddFoodBtn));


            // Fermeture modales au clic extérieur ou Esc
            window.addEventListener('click', (e) => {
                if (e.target === infoModal) closeModal(infoModal);
                if (e.target === editModal) closeModal(editModal);
            });
            window.addEventListener('keydown', (e) => {
                 if (e.key === 'Escape') {
                    if (infoModal.style.display === 'block') closeModal(infoModal);
                    if (editModal.style.display === 'block') closeModal(editModal);
                 }
            });


            // --- INITIALISATION ---
             console.log("Application Calculateur de Calories initialisée.");
             updateFoodItems(); // Peupler la liste des aliments initiale si une catégorie est sélectionnée par défaut
             updateMealTitles(); // Mettre à jour les titres H2 initiaux
             initCharts();
             updateDailySummary(); // Afficher 0 partout au début
             updateActiveTab(); // Assurer que le premier onglet est bien stylé

             // Initialiser les états ARIA des sections repliables
             toggleSection(generatorContent, generatorToggleIcon, toggleGeneratorBtn, true); // Déplié au début
             toggleSection(addFoodContent, addFoodToggleIcon, toggleAddFoodBtn, true); // Déplié au début

        }); // Fin DOMContentLoaded
    </script>
</body>
</html>
